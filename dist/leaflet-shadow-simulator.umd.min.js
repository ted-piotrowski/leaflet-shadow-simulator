/**
 * Copyright Ted Piotrowski 2023
 * Package: leaflet-shadow-simulator
 * Version: 0.20.0
 * For licensing visit: https://shademap.app/about/
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("leaflet"),require("suncalc")):"function"==typeof define&&define.amd?define(["leaflet","suncalc"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).ShadeMap=e(t.L,t.suncalc)}(this,(function(t,e){"use strict";function r(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var n=r(e),o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])})(t,e)};function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var a=function(){return(a=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var o in e=arguments[r])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function u(t,e,r,n){return new(r||(r=Promise))((function(o,i){function a(t){try{s(n.next(t))}catch(t){i(t)}}function u(t){try{s(n.throw(t))}catch(t){i(t)}}function s(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(a,u)}s((n=n.apply(t,e||[])).next())}))}function s(t,e){var r,n,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,n=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=e.call(t,a)}catch(t){i=[6,t],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}}function l(t,e,r){if(r||2===arguments.length)for(var n,o=0,i=e.length;o<i;o++)!n&&o in e||(n||(n=Array.prototype.slice.call(e,0,o)),n[o]=e[o]);return t.concat(n||Array.prototype.slice.call(e))}var c=function(e){function r(t,r,n){void 0===n&&(n={});var o=e.call(this,"",r,n)||this;return o._url=t,o}return i(r,e),r.prototype._initImage=function(){var e="CANVAS"===this._url.tagName,r=this._image=e?this._url:t.DomUtil.create("canvas");return t.DomUtil.addClass(r,"leaflet-image-layer"),this._zoomAnimated&&t.DomUtil.addClass(r,"leaflet-zoom-animated"),this.options.className&&t.DomUtil.addClass(r,this.options.className),r.onselectstart=t.Util.falseFn,r.onmousemove=t.Util.falseFn,this},r}(t.ImageOverlay);function f(t,e,r){var n=e[1],o=e[0],i=n-o;return t===n&&r?t:((t-o)%i+i)%i+o}function h(t,e){if(!1===e)return t;var r=Math.pow(10,void 0===e?6:e);return Math.round(t*r)/r}var p=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)};function d(t,e,r){this.x=r?Math.round(t):t,this.y=r?Math.round(e):e}var x=Math.trunc||function(t){return t>0?Math.floor(t):Math.ceil(t)};function m(t,e,r){return t instanceof d?t:p(t)?new d(t[0],t[1]):null==t?t:"object"==typeof t&&"x"in t&&"y"in t?new d(t.x,t.y):new d(t,e,r)}function _(t,e){if(t)for(var r=e?[t,e]:t,n=0,o=r.length;n<o;n++)this.extend(r[n])}function v(t,e){return!t||t instanceof _?t:new _(t,e)}function g(t,e){if(t)for(var r=e?[t,e]:t,n=0,o=r.length;n<o;n++)this.extend(r[n])}function y(t,e){return t instanceof g?t:new g(t,e)}d.prototype={clone:function(){return new d(this.x,this.y)},add:function(t){return this.clone()._add(m(t))},_add:function(t){return this.x+=t.x,this.y+=t.y,this},subtract:function(t){return this.clone()._subtract(m(t))},_subtract:function(t){return this.x-=t.x,this.y-=t.y,this},divideBy:function(t){return this.clone()._divideBy(t)},_divideBy:function(t){return this.x/=t,this.y/=t,this},multiplyBy:function(t){return this.clone()._multiplyBy(t)},_multiplyBy:function(t){return this.x*=t,this.y*=t,this},scaleBy:function(t){return new d(this.x*t.x,this.y*t.y)},unscaleBy:function(t){return new d(this.x/t.x,this.y/t.y)},round:function(){return this.clone()._round()},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},floor:function(){return this.clone()._floor()},_floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},ceil:function(){return this.clone()._ceil()},_ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},trunc:function(){return this.clone()._trunc()},_trunc:function(){return this.x=x(this.x),this.y=x(this.y),this},distanceTo:function(t){var e=(t=m(t)).x-this.x,r=t.y-this.y;return Math.sqrt(e*e+r*r)},equals:function(t){return(t=m(t)).x===this.x&&t.y===this.y},contains:function(t){return t=m(t),Math.abs(t.x)<=Math.abs(this.x)&&Math.abs(t.y)<=Math.abs(this.y)},toString:function(){return"Point("+h(this.x)+", "+h(this.y)+")"}},_.prototype={extend:function(t){var e,r;if(!t)return this;if(t instanceof d||"number"==typeof t[0]||"x"in t)e=r=m(t);else if(e=(t=v(t)).min,r=t.max,!e||!r)return this;return this.min||this.max?(this.min.x=Math.min(e.x,this.min.x),this.max.x=Math.max(r.x,this.max.x),this.min.y=Math.min(e.y,this.min.y),this.max.y=Math.max(r.y,this.max.y)):(this.min=e.clone(),this.max=r.clone()),this},getCenter:function(t){return m((this.min.x+this.max.x)/2,(this.min.y+this.max.y)/2,t)},getBottomLeft:function(){return m(this.min.x,this.max.y)},getTopRight:function(){return m(this.max.x,this.min.y)},getTopLeft:function(){return this.min},getBottomRight:function(){return this.max},getSize:function(){return this.max.subtract(this.min)},contains:function(t){var e,r;return(t="number"==typeof t[0]||t instanceof d?m(t):v(t))instanceof _?(e=t.min,r=t.max):e=r=t,e.x>=this.min.x&&r.x<=this.max.x&&e.y>=this.min.y&&r.y<=this.max.y},intersects:function(t){t=v(t);var e=this.min,r=this.max,n=t.min,o=t.max,i=o.x>=e.x&&n.x<=r.x,a=o.y>=e.y&&n.y<=r.y;return i&&a},overlaps:function(t){t=v(t);var e=this.min,r=this.max,n=t.min,o=t.max,i=o.x>e.x&&n.x<r.x,a=o.y>e.y&&n.y<r.y;return i&&a},isValid:function(){return!(!this.min||!this.max)},pad:function(t){var e=this.min,r=this.max,n=Math.abs(e.x-r.x)*t,o=Math.abs(e.y-r.y)*t;return v(m(e.x-n,e.y-o),m(r.x+n,r.y+o))},equals:function(t){return!!t&&(t=v(t),this.min.equals(t.getTopLeft())&&this.max.equals(t.getBottomRight()))}},g.prototype={extend:function(t){var e,r,n=this._southWest,o=this._northEast;if(t instanceof T)e=t,r=t;else{if(!(t instanceof g))return t?this.extend(w(t)||y(t)):this;if(e=t._southWest,r=t._northEast,!e||!r)return this}return n||o?(n.lat=Math.min(e.lat,n.lat),n.lng=Math.min(e.lng,n.lng),o.lat=Math.max(r.lat,o.lat),o.lng=Math.max(r.lng,o.lng)):(this._southWest=new T(e.lat,e.lng),this._northEast=new T(r.lat,r.lng)),this},pad:function(t){var e=this._southWest,r=this._northEast,n=Math.abs(e.lat-r.lat)*t,o=Math.abs(e.lng-r.lng)*t;return new g(new T(e.lat-n,e.lng-o),new T(r.lat+n,r.lng+o))},getCenter:function(){return new T((this._southWest.lat+this._northEast.lat)/2,(this._southWest.lng+this._northEast.lng)/2)},getSouthWest:function(){return this._southWest},getNorthEast:function(){return this._northEast},getNorthWest:function(){return new T(this.getNorth(),this.getWest())},getSouthEast:function(){return new T(this.getSouth(),this.getEast())},getWest:function(){return this._southWest.lng},getSouth:function(){return this._southWest.lat},getEast:function(){return this._northEast.lng},getNorth:function(){return this._northEast.lat},contains:function(t){t="number"==typeof t[0]||t instanceof T||"lat"in t?w(t):y(t);var e,r,n=this._southWest,o=this._northEast;return t instanceof g?(e=t.getSouthWest(),r=t.getNorthEast()):e=r=t,e.lat>=n.lat&&r.lat<=o.lat&&e.lng>=n.lng&&r.lng<=o.lng},intersects:function(t){t=y(t);var e=this._southWest,r=this._northEast,n=t.getSouthWest(),o=t.getNorthEast(),i=o.lat>=e.lat&&n.lat<=r.lat,a=o.lng>=e.lng&&n.lng<=r.lng;return i&&a},overlaps:function(t){t=y(t);var e=this._southWest,r=this._northEast,n=t.getSouthWest(),o=t.getNorthEast(),i=o.lat>e.lat&&n.lat<r.lat,a=o.lng>e.lng&&n.lng<r.lng;return i&&a},toBBoxString:function(){return[this.getWest(),this.getSouth(),this.getEast(),this.getNorth()].join(",")},equals:function(t,e){return!!t&&(t=y(t),this._southWest.equals(t.getSouthWest(),e)&&this._northEast.equals(t.getNorthEast(),e))},isValid:function(){return!(!this._southWest||!this._northEast)}};var E=function(t){var e,r,n,o;for(r=1,n=arguments.length;r<n;r++)for(e in o=arguments[r])t[e]=o[e];return t}({},{latLngToPoint:function(t,e){var r=this.projection.project(t),n=this.scale(e);return this.transformation._transform(r,n)},pointToLatLng:function(t,e){var r=this.scale(e),n=this.transformation.untransform(t,r);return this.projection.unproject(n)},project:function(t){return this.projection.project(t)},unproject:function(t){return this.projection.unproject(t)},scale:function(t){return 256*Math.pow(2,t)},zoom:function(t){return Math.log(t/256)/Math.LN2},getProjectedBounds:function(t){if(this.infinite)return null;var e=this.projection.bounds,r=this.scale(t);return new _(this.transformation.transform(e.min,r),this.transformation.transform(e.max,r))},infinite:!1,wrapLatLng:function(t){var e=this.wrapLng?f(t.lng,this.wrapLng,!0):t.lng;return new T(this.wrapLat?f(t.lat,this.wrapLat,!0):t.lat,e,t.alt)},wrapLatLngBounds:function(t){var e=t.getCenter(),r=this.wrapLatLng(e),n=e.lat-r.lat,o=e.lng-r.lng;if(0===n&&0===o)return t;var i=t.getSouthWest(),a=t.getNorthEast();return new g(new T(i.lat-n,i.lng-o),new T(a.lat-n,a.lng-o))}},{wrapLng:[-180,180],R:6371e3,distance:function(t,e){var r=Math.PI/180,n=t.lat*r,o=e.lat*r,i=Math.sin((e.lat-t.lat)*r/2),a=Math.sin((e.lng-t.lng)*r/2),u=i*i+Math.cos(n)*Math.cos(o)*a*a,s=2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u));return this.R*s}});function T(t,e,r){if(isNaN(t)||isNaN(e))throw new Error("Invalid LatLng object: ("+t+", "+e+")");this.lat=+t,this.lng=+e,void 0!==r&&(this.alt=+r)}function w(t,e,r){return t instanceof T?t:p(t)&&"object"!=typeof t[0]?3===t.length?new T(t[0],t[1],t[2]):2===t.length?new T(t[0],t[1]):null:null==t?t:"object"==typeof t&&"lat"in t?new T(t.lat,"lng"in t?t.lng:t.lon,t.alt):void 0===e?null:new T(t,e,r)}T.prototype={equals:function(t,e){return!!t&&(t=w(t),Math.max(Math.abs(this.lat-t.lat),Math.abs(this.lng-t.lng))<=(void 0===e?1e-9:e))},toString:function(t){return"LatLng("+h(this.lat,t)+", "+h(this.lng,t)+")"},distanceTo:function(t){return E.distance(this,w(t))},wrap:function(){return E.wrapLatLng(this)},toBounds:function(t){var e=180*t/40075017,r=e/Math.cos(Math.PI/180*this.lat);return y([this.lat-e,this.lng-r],[this.lat+e,this.lng+r])},clone:function(){return new T(this.lat,this.lng,this.alt)}};var R,b=8848,M=256,A=function(t){var e=function(t,e,r){var n=t.createShader(t.VERTEX_SHADER);if(null===n)return null;t.shaderSource(n,e),t.compileShader(n);var o=t.createShader(t.FRAGMENT_SHADER);if(null===o)return null;t.shaderSource(o,r),t.compileShader(o);var i=t.createProgram();if(null===i)return null;t.attachShader(i,n),t.attachShader(i,o),t.linkProgram(i),t.getProgramParameter(i,t.LINK_STATUS)||console.log(t.getProgramInfoLog(i));return i}(t,"\nuniform vec3 xyz;\nuniform vec2 dimensions;\nattribute vec2 a_position;\nfloat PI = 3.141592653589793;\nvarying vec2 vCoord;\n\n\tvoid main() {\n\t\tif (abs(a_position) == vec2(1,1)) {\n\t\t\tgl_Position = vec4(a_position, 0, 1);\n\t\t\tvCoord = a_position * 0.5 + 0.5;\n\t\t\treturn;\n\t\t}\n\t\tfloat x = ((a_position.x + 180.0) / 360.0 * pow(2.0, xyz.z)) * 256.0 - xyz.x;\n\t\tfloat y = (1.0 - (log(a_position.y) / PI)) / 2.0 * pow(2.0, xyz.z) * 256.0 - xyz.y;\n\t\tvec2 transformed = vec2(x, y);\n\t\tvec2 normalized = transformed / dimensions;\n\t\tvec2 final = normalized * 2.0 - 1.0;\n\t\tgl_Position = vec4(final, 0, 1);\n\t}\n","\n#ifdef GL_FRAGMENT_PRECISION_HIGH\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\nuniform vec4 color;\nuniform sampler2D height_map;\nvarying vec2 vCoord;\n\nvoid main() {\n\tif (color == vec4(0,0,0,0)) {\n\t \tvec4 textureColor = texture2D(height_map, vec2(vCoord.x, vCoord.y));\n\t \tgl_FragColor = vec4(textureColor.b, textureColor.a, 0, 1.0);\n\t\treturn;\n\t} \n\tgl_FragColor = color;\n}\n"),r=t.getAttribLocation(e,"a_position"),n=t.getUniformLocation(e,"xyz"),o=t.getUniformLocation(e,"dimensions"),i=t.getUniformLocation(e,"height_map"),a=t.getUniformLocation(e,"color"),u=t.createBuffer(),s=t.createBuffer(),l=t.createTexture();R={program:e,positionAttributeLocation:r,xyzUniformLocation:n,dimensionsUniformLocation:o,heightMapUniformLocation:i,colorUniformLocation:a,positionBuffer:u,indexBuffer:s,targetTexture:l}};var S=function(){function t(){this.events={}}return t.prototype.on=function(t,e){var r=this;return"object"!=typeof this.events[t]&&(this.events[t]=[]),this.events[t].push(e),function(){return r.removeListener(t,e)}},t.prototype.removeListener=function(t,e){if("object"==typeof this.events[t]){var r=this.events[t].indexOf(e);r>-1&&this.events[t].splice(r,1)}},t.prototype.removeAllListeners=function(){var t=this;Object.keys(this.events).forEach((function(e){return t.events[e].splice(0,t.events[e].length)}))},t.prototype.emit=function(t){for(var e=this,r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];"object"==typeof this.events[t]&&l([],this.events[t]).forEach((function(t){return t.apply(e,r)}))},t.prototype.once=function(t,e){var r=this,n=this.on(t,(function(){for(var t=[],o=0;o<arguments.length;o++)t[o]=arguments[o];n(),e.apply(r,t)}));return n},t}();function L(t,e,r){r=r||2;var n,o,i,a,u,s,l,c=e&&e.length,f=c?e[0]*r:t.length,h=U(t,0,f,r,!0),p=[];if(!h||h.next===h.prev)return p;if(c&&(h=function(t,e,r,n){var o,i,a,u=[];for(o=0,i=e.length;o<i;o++)(a=U(t,e[o]*n,o<i-1?e[o+1]*n:t.length,n,!1))===a.next&&(a.steiner=!0),u.push(H(a));for(u.sort(N),o=0;o<u.length;o++)r=X(u[o],r);return r}(t,e,h,r)),t.length>80*r){n=i=t[0],o=a=t[1];for(var d=r;d<f;d+=r)(u=t[d])<n&&(n=u),(s=t[d+1])<o&&(o=s),u>i&&(i=u),s>a&&(a=s);l=0!==(l=Math.max(i-n,a-o))?32767/l:0}return D(h,p,r,n,o,l,0),p}function U(t,e,r,n,o){var i,a;if(o===tt(t,e,r,n)>0)for(i=e;i<r;i+=n)a=J(i,t[i],t[i+1],a);else for(i=r-n;i>=e;i-=n)a=J(i,t[i],t[i+1],a);return a&&j(a,a.next)&&($(a),a=a.next),a}function P(t,e){if(!t)return t;e||(e=t);var r,n=t;do{if(r=!1,n.steiner||!j(n,n.next)&&0!==Z(n.prev,n,n.next))n=n.next;else{if($(n),(n=e=n.prev)===n.next)break;r=!0}}while(r||n!==e);return e}function D(t,e,r,n,o,i,a){if(t){!a&&i&&function(t,e,r,n){var o=t;do{0===o.z&&(o.z=z(o.x,o.y,e,r,n)),o.prevZ=o.prev,o.nextZ=o.next,o=o.next}while(o!==t);o.prevZ.nextZ=null,o.prevZ=null,function(t){var e,r,n,o,i,a,u,s,l=1;do{for(r=t,t=null,i=null,a=0;r;){for(a++,n=r,u=0,e=0;e<l&&(u++,n=n.nextZ);e++);for(s=l;u>0||s>0&&n;)0!==u&&(0===s||!n||r.z<=n.z)?(o=r,r=r.nextZ,u--):(o=n,n=n.nextZ,s--),i?i.nextZ=o:t=o,o.prevZ=i,i=o;r=n}i.nextZ=null,l*=2}while(a>1)}(o)}(t,n,o,i);for(var u,s,l=t;t.prev!==t.next;)if(u=t.prev,s=t.next,i?C(t,n,o,i):I(t))e.push(u.i/r|0),e.push(t.i/r|0),e.push(s.i/r|0),$(t),t=s.next,l=s.next;else if((t=s)===l){a?1===a?D(t=F(P(t),e,r),e,r,n,o,i,2):2===a&&B(t,e,r,n,o,i):D(P(t),e,r,n,o,i,1);break}}}function I(t){var e=t.prev,r=t,n=t.next;if(Z(e,r,n)>=0)return!1;for(var o=e.x,i=r.x,a=n.x,u=e.y,s=r.y,l=n.y,c=o<i?o<a?o:a:i<a?i:a,f=u<s?u<l?u:l:s<l?s:l,h=o>i?o>a?o:a:i>a?i:a,p=u>s?u>l?u:l:s>l?s:l,d=n.next;d!==e;){if(d.x>=c&&d.x<=h&&d.y>=f&&d.y<=p&&W(o,u,i,s,a,l,d.x,d.y)&&Z(d.prev,d,d.next)>=0)return!1;d=d.next}return!0}function C(t,e,r,n){var o=t.prev,i=t,a=t.next;if(Z(o,i,a)>=0)return!1;for(var u=o.x,s=i.x,l=a.x,c=o.y,f=i.y,h=a.y,p=u<s?u<l?u:l:s<l?s:l,d=c<f?c<h?c:h:f<h?f:h,x=u>s?u>l?u:l:s>l?s:l,m=c>f?c>h?c:h:f>h?f:h,_=z(p,d,e,r,n),v=z(x,m,e,r,n),g=t.prevZ,y=t.nextZ;g&&g.z>=_&&y&&y.z<=v;){if(g.x>=p&&g.x<=x&&g.y>=d&&g.y<=m&&g!==o&&g!==a&&W(u,c,s,f,l,h,g.x,g.y)&&Z(g.prev,g,g.next)>=0)return!1;if(g=g.prevZ,y.x>=p&&y.x<=x&&y.y>=d&&y.y<=m&&y!==o&&y!==a&&W(u,c,s,f,l,h,y.x,y.y)&&Z(y.prev,y,y.next)>=0)return!1;y=y.nextZ}for(;g&&g.z>=_;){if(g.x>=p&&g.x<=x&&g.y>=d&&g.y<=m&&g!==o&&g!==a&&W(u,c,s,f,l,h,g.x,g.y)&&Z(g.prev,g,g.next)>=0)return!1;g=g.prevZ}for(;y&&y.z<=v;){if(y.x>=p&&y.x<=x&&y.y>=d&&y.y<=m&&y!==o&&y!==a&&W(u,c,s,f,l,h,y.x,y.y)&&Z(y.prev,y,y.next)>=0)return!1;y=y.nextZ}return!0}function F(t,e,r){var n=t;do{var o=n.prev,i=n.next.next;!j(o,i)&&Y(o,n,n.next,i)&&q(o,i)&&q(i,o)&&(e.push(o.i/r|0),e.push(n.i/r|0),e.push(i.i/r|0),$(n),$(n.next),n=t=i),n=n.next}while(n!==t);return P(n)}function B(t,e,r,n,o,i){var a=t;do{for(var u=a.next.next;u!==a.prev;){if(a.i!==u.i&&G(a,u)){var s=V(a,u);return a=P(a,a.next),s=P(s,s.next),D(a,e,r,n,o,i,0),void D(s,e,r,n,o,i,0)}u=u.next}a=a.next}while(a!==t)}function N(t,e){return t.x-e.x}function X(t,e){var r=function(t,e){var r,n=e,o=t.x,i=t.y,a=-1/0;do{if(i<=n.y&&i>=n.next.y&&n.next.y!==n.y){var u=n.x+(i-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(u<=o&&u>a&&(a=u,r=n.x<n.next.x?n:n.next,u===o))return r}n=n.next}while(n!==e);if(!r)return null;var s,l=r,c=r.x,f=r.y,h=1/0;n=r;do{o>=n.x&&n.x>=c&&o!==n.x&&W(i<f?o:a,i,c,f,i<f?a:o,i,n.x,n.y)&&(s=Math.abs(i-n.y)/(o-n.x),q(n,t)&&(s<h||s===h&&(n.x>r.x||n.x===r.x&&O(r,n)))&&(r=n,h=s)),n=n.next}while(n!==l);return r}(t,e);if(!r)return e;var n=V(r,t);return P(n,n.next),P(r,r.next)}function O(t,e){return Z(t.prev,t,e.prev)<0&&Z(e.next,t,t.next)<0}function z(t,e,r,n,o){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-r)*o|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-n)*o|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function H(t){var e=t,r=t;do{(e.x<r.x||e.x===r.x&&e.y<r.y)&&(r=e),e=e.next}while(e!==t);return r}function W(t,e,r,n,o,i,a,u){return(o-a)*(e-u)>=(t-a)*(i-u)&&(t-a)*(n-u)>=(r-a)*(e-u)&&(r-a)*(i-u)>=(o-a)*(n-u)}function G(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var r=t;do{if(r.i!==t.i&&r.next.i!==t.i&&r.i!==e.i&&r.next.i!==e.i&&Y(r,r.next,t,e))return!0;r=r.next}while(r!==t);return!1}(t,e)&&(q(t,e)&&q(e,t)&&function(t,e){var r=t,n=!1,o=(t.x+e.x)/2,i=(t.y+e.y)/2;do{r.y>i!=r.next.y>i&&r.next.y!==r.y&&o<(r.next.x-r.x)*(i-r.y)/(r.next.y-r.y)+r.x&&(n=!n),r=r.next}while(r!==t);return n}(t,e)&&(Z(t.prev,t,e.prev)||Z(t,e.prev,e))||j(t,e)&&Z(t.prev,t,t.next)>0&&Z(e.prev,e,e.next)>0)}function Z(t,e,r){return(e.y-t.y)*(r.x-e.x)-(e.x-t.x)*(r.y-e.y)}function j(t,e){return t.x===e.x&&t.y===e.y}function Y(t,e,r,n){var o=K(Z(t,e,r)),i=K(Z(t,e,n)),a=K(Z(r,n,t)),u=K(Z(r,n,e));return o!==i&&a!==u||(!(0!==o||!k(t,r,e))||(!(0!==i||!k(t,n,e))||(!(0!==a||!k(r,t,n))||!(0!==u||!k(r,e,n)))))}function k(t,e,r){return e.x<=Math.max(t.x,r.x)&&e.x>=Math.min(t.x,r.x)&&e.y<=Math.max(t.y,r.y)&&e.y>=Math.min(t.y,r.y)}function K(t){return t>0?1:t<0?-1:0}function q(t,e){return Z(t.prev,t,t.next)<0?Z(t,e,t.next)>=0&&Z(t,t.prev,e)>=0:Z(t,e,t.prev)<0||Z(t,t.next,e)<0}function V(t,e){var r=new Q(t.i,t.x,t.y),n=new Q(e.i,e.x,e.y),o=t.next,i=e.prev;return t.next=e,e.prev=t,r.next=o,o.prev=r,n.next=r,r.prev=n,i.next=n,n.prev=i,n}function J(t,e,r,n){var o=new Q(t,e,r);return n?(o.next=n.next,o.prev=n,n.next.prev=o,n.next=o):(o.prev=o,o.next=o),o}function $(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Q(t,e,r){this.i=t,this.x=e,this.y=r,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function tt(t,e,r,n){for(var o=0,i=e,a=r-n;i<r;i+=n)o+=(t[a]-t[i])*(t[i+1]+t[a+1]),a=i;return o}function et(t,e){return t.filter((function(t){return"MultiPolygon"===t.geometry.type})).forEach((function(e){var r=e.geometry;if(e.properties,e.type,"MultiPolygon"===r.type)for(var n=0;n<r.coordinates.length;n++)t.push(a(a({},e),{geometry:a(a({},r),{type:"Polygon",coordinates:r.coordinates[n]})}))})),t.filter((function(t){return"Polygon"===t.geometry.type})).map((function(t){var e=t.geometry,r=t.properties,n=L.flatten(e.coordinates).vertices,o=new Float32Array(n.map((function(t,e){if(e%2==1){var r=t*Math.PI/180;return Math.tan(r)+1/Math.cos(r)}return t}))),i=L(n);return{aPosition:o,cuts:i.length>256?new Uint16Array(i):new Uint8Array(i),buildingHeight:function(t){var e=t,r=e.height,n=void 0===r?0:r,o=e.levels,i=void 0===o?0:o,a=e.render_height,u=void 0===a?0:a;if(i)return 3.04*i;return Math.max(n,u)}(r),startPos:[n[0],n[1]]}}))}L.deviation=function(t,e,r,n){var o=e&&e.length,i=o?e[0]*r:t.length,a=Math.abs(tt(t,0,i,r));if(o)for(var u=0,s=e.length;u<s;u++){var l=e[u]*r,c=u<s-1?e[u+1]*r:t.length;a-=Math.abs(tt(t,l,c,r))}var f=0;for(u=0;u<n.length;u+=3){var h=n[u]*r,p=n[u+1]*r,d=n[u+2]*r;f+=Math.abs((t[h]-t[d])*(t[p+1]-t[h+1])-(t[h]-t[p])*(t[d+1]-t[h+1]))}return 0===a&&0===f?0:Math.abs((f-a)/a)},L.flatten=function(t){for(var e=t[0][0].length,r={vertices:[],holes:[],dimensions:e},n=0,o=0;o<t.length;o++){for(var i=0;i<t[o].length;i++)for(var a=0;a<e;a++)r.vertices.push(t[o][i][a]);o>0&&(n+=t[o-1].length,r.holes.push(n))}return r};var rt=.40909994067971484,nt=function(t){var e=t.valueOf()/864e5-10957.5,r=6.240059966692059+.017201969994578018*e,n=r+.017453292519943295*(1.9148*Math.sin(r)+.02*Math.sin(2*r)+3e-4*Math.sin(3*r))+1.796593062783907+Math.PI,o=Math.atan2(Math.sin(n)*Math.cos(rt),Math.cos(n));return{dec:Math.asin(Math.sin(rt)*Math.sin(n)),Hi:(4.889714432387314+6.3003876824396166*e-o)%(2*Math.PI)+2*Math.PI}},ot=function(t){return new Promise((function(e,r){var n=new Int32Array(t.buffer).reduce((function(t,e){return Math.max(t,(n=(256*(255&(r=e))+(r>>8&255))/5,o=(256*(r>>16&255)+(r>>24&255))/5,Math.max(n,o)));var r,n,o}),0);e({maxHeight:Math.min(b,n)})}))},it=document.createElement("canvas"),at=it.getContext("2d",{antialias:!1,alpha:!1});null!==at&&(at.imageSmoothingEnabled=!1),it.width=M,it.height=M;var ut,st=[],lt=0,ct={width:0,height:0,tileLatLngBounds:new g(new T(0,0),new T(0,0)),imageData:new Uint8ClampedArray(0),visibleDEMPixelBounds:new _(new d(0,0),new d(0,0)),maxHeight:b,maxBuildingHeight:0,raster:[],demZoom:0,dirty:!1,outputWidth:0,outputHeight:0},ft=function(t){return u(void 0,void 0,void 0,(function(){var e,r,n,o,i,l,c,f,h,p,x,m,v,y,E,T,w,A,S,L,U,P,D,I,C,F,B,N,X,O,z,H,W,G,Z,j,Y,k,K,q,V;return s(this,(function(J){switch(J.label){case 0:e=t.map,r=t.getFeatures,n=t.terrainSource,o=t.tileLoaded,i=t.gl,l=t.bounds,c=n.getSourceUrl,f=n.getElevation,h=n.maxZoom,p=n.tileSize,rt={map:e,getFeatures:r},x=u(void 0,void 0,void 0,(function(){var t,e,r,n;return s(this,(function(o){switch(o.label){case 0:t=rt.map,e=rt.getFeatures,o.label=1;case 1:return o.trys.push([1,3,,4]),r=et,[4,e()];case 2:return[2,r.apply(void 0,[o.sent(),t])];case 3:return n=o.sent(),console.log("Error merging buildings",n),[3,4];case 4:return[2,[]]}}))})),m=e.getZoom(),J.label=1;case 1:return J.trys.push([1,4,,5]),m=Math.min(h,m),v=Math.round(m),E=(y=l).getNorthWest(),T=y.getSouthEast(),w=new _(e.project(E,m),e.project(T,m)),A=w.max.x-w.min.x,S=w.max.y-w.min.y,L=new _(e.project(E,v),e.project(T,v)),U=new d(L.min.x,L.min.y),P=L.max.x-L.min.x,D=L.max.y-L.min.y,(I=L.max.subtract(L.min)).y>I.x&&(U.x-=M,P+=512),C=function(t){for(var e=t.upperLeft,r=t.zoom,n=t.innerWidth,o=t.innerHeight,i=e.divideBy(M).floor(),a=i.x+Math.floor((n+M)/M),u=Math.min(i.y+Math.floor((o+M)/M),Math.pow(2,r)-1),s=[],l=i.x;l<=a;l++)for(var c=i.y;c<=u;c++)s.push({x:l,y:c,z:r});return s}({upperLeft:U,zoom:v,innerWidth:P,innerHeight:D}),F=function(t){t.sort((function(t,e){return t.y!==e.y?t.y-e.y:t.x-e.x}));var e=t.reduce((function(t,e){return e.x<t.x?e:t})).x,r=t.reduce((function(t,e){return e.y<t.y?e:t})).y;return t.map((function(t){var n=Math.pow(2,t.z);return{x:(t.x%n+n)%n,y:(t.y%n+n)%n,z:t.z,xOffset:(t.x-e)*M,yOffset:(t.y-r)*M}}))}(C),(B=JSON.stringify(F))===ut&&v<h?[2,ct=a(a({},ct),{visibleDEMPixelBounds:L,demZoom:v,dirty:!0})]:(ut=B,N={width:(tt=F).reduce((function(t,e){return e.xOffset>t.xOffset?e:t})).xOffset+M,height:tt.reduce((function(t,e){return e.yOffset>t.yOffset?e:t})).yOffset+M},[4,($=F,Q={width:X=N.width,height:O=N.height,crossOrigin:"Anonymous",getSourceUrl:c,getElevation:f,tileSize:p,tileLoaded:o},u(void 0,void 0,void 0,(function(){var t,e,r,n,o,i,a,l,c,f,h;return s(this,(function(p){switch(p.label){case 0:if(t=Q.width,e=Q.height,r=Q.crossOrigin,n=Q.getSourceUrl,o=Q.getElevation,i=Q.tileSize,a=Q.tileLoaded,!at)return[3,5];l=new Uint8ClampedArray(2*t*e),st.forEach((function(t){return t.src=""})),st=[],lt=0,c=new Set,$.forEach((function(t){var e=i===M?t.x:Math.floor(t.x/2),r=i===M?t.y:Math.floor(t.y/2),o=i===M?t.z:t.z-1;c.add(n({x:e,y:r,z:o}))})),f=Array.from(c).map((function(e){return u(void 0,void 0,void 0,(function(){return s(this,(function(u){return[2,new Promise((function(a,u){var s=new Image;st.push(s),s.onload=function(){$.filter((function(t){var r=i===M?t.x:Math.floor(t.x/2),o=i===M?t.y:Math.floor(t.y/2),a=i===M?t.z:t.z-1;return e===n({x:r,y:o,z:a})})).forEach((function(e){if(i===M)at.drawImage(s,0,0,M,M);else{var r=514===i?1:0,n=e.x%2*M,a=e.y%2*M;at.drawImage(s,n,a,M+r,M+r,0,0,M,M)}for(var u=at.getImageData(0,0,M,M).data,c=0;c<u.length;c+=4){var f=5*(o({r:u[c],g:u[c+1],b:u[c+2],a:0})||0),h=Math.floor(f/256),p=Math.floor(f%256);u[c/2]=h,u[c/2+1]=p}for(c=0;c<M;c++)l.set(u.slice(c*M*2,(c+1)*M*2),2*(e.yOffset*t+c*t+e.xOffset))})),a(null)},s.onerror=function(t){if(s.src!==s.originalSource)return u("new tiles requested");a(null)},s.crossOrigin=r||null,s.src=e,s.originalSource=s.src})).then((function(){lt++,a(lt,st.length)}))]}))}))})),p.label=1;case 1:return p.trys.push([1,3,,4]),[4,Promise.all(f)];case 2:return p.sent(),[3,4];case 3:return h=p.sent(),console.log(f.length+" requests aborted",h),[2,null];case 4:return st=[],[2,l];case 5:throw new Error("Could not get canvas context for merging tile images")}}))})))]);case 2:return null===(z=J.sent())?[2,ct=a(a({},ct),{visibleDEMPixelBounds:L,demZoom:v,dirty:!1})]:(H=function(t){var e=t.upperLeft,r=t.width,n=t.height,o=e.divideBy(M).floor().multiplyBy(M),i=o.add([r,n]);return new _(o,i)}({upperLeft:U,width:X,height:O}),W=new g(e.unproject(H.getTopLeft(),v),e.unproject(H.getBottomRight(),v)),G=0,[4,x]);case 3:return Z=J.sent(),G=function(t){var e=t.features,r=t.upperLeftTile,n=t.map,o=t.width,i=t.height,a=t.imageData,u=t.gl,s=r.x,l=r.y,c=r.z,f=R.program,h=R.positionAttributeLocation,p=R.xyzUniformLocation,x=R.dimensionsUniformLocation,m=R.heightMapUniformLocation,_=R.colorUniformLocation,v=R.positionBuffer,g=R.indexBuffer,y=R.targetTexture,E=0;u.useProgram(f),u.activeTexture(u.TEXTURE1);var T=u.createTexture();u.bindTexture(u.TEXTURE_2D,T),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,u.CLAMP_TO_EDGE),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,u.CLAMP_TO_EDGE),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,u.NEAREST),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,u.NEAREST),u.texImage2D(u.TEXTURE_2D,0,u.LUMINANCE_ALPHA,o,i,0,u.LUMINANCE_ALPHA,u.UNSIGNED_BYTE,a);var w=o*(n.getZoom()>15?2:1),b=i*(n.getZoom()>15?2:1);u.activeTexture(u.TEXTURE0),u.bindTexture(u.TEXTURE_2D,y),u.texImage2D(u.TEXTURE_2D,0,u.RGBA,w,b,0,u.RGBA,u.UNSIGNED_BYTE,null),n.getZoom()>15&&e.length>0?(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,u.NEAREST),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,u.NEAREST)):(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,u.LINEAR),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,u.LINEAR)),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,u.CLAMP_TO_EDGE),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,u.CLAMP_TO_EDGE),u.viewport(0,0,w,b);var A=u.createFramebuffer();u.bindFramebuffer(u.FRAMEBUFFER,A);var S=u.COLOR_ATTACHMENT0;u.framebufferTexture2D(u.FRAMEBUFFER,S,u.TEXTURE_2D,y,0),u.bindBuffer(u.ARRAY_BUFFER,v),u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,g),u.clearColor(0,0,0,0),u.clear(u.COLOR_BUFFER_BIT);var L=s*M,U=l*M,P=new d(L,U);u.uniform3f(p,L,U,c),u.uniform2f(x,o,i),u.uniform1i(m,1);var D=new Float32Array([-1,-1,1,-1,-1,1,1,1]);return u.enableVertexAttribArray(h),u.bufferData(u.ARRAY_BUFFER,D,u.STATIC_DRAW),u.vertexAttribPointer(h,2,u.FLOAT,!1,0,0),u.uniform4f(_,0,0,0,0),u.drawArrays(u.TRIANGLE_STRIP,0,4),e.forEach((function(t){var e=t.buildingHeight,r=t.aPosition,i=t.cuts,s=t.startPos,l=n.project({lng:s[0],lat:s[1]},c).subtract(P).floor(),f=256*a[l.y*o*2+2*l.x]+a[l.y*o*2+2*l.x+1]+5*e;if(!Number.isNaN(f)){var p=Math.floor(f/256)/256,d=Math.floor(f%256)/256;E=Math.max(E,f/5),u.uniform4f(_,p,d,0,1),u.bufferData(u.ARRAY_BUFFER,r,u.DYNAMIC_DRAW),u.vertexAttribPointer(h,2,u.FLOAT,!1,0,0),u.bufferData(u.ELEMENT_ARRAY_BUFFER,i,u.DYNAMIC_DRAW),u.drawElements(u.TRIANGLES,i.length,i.length>256?u.UNSIGNED_SHORT:u.UNSIGNED_BYTE,0)}})),u.deleteTexture(T),E}({upperLeftTile:F[0],width:X,height:O,map:e,features:Z,imageData:z,screenPixelBounds:w,gl:i}),b,j=window.innerWidth*window.innerHeight,Y=A*S,k=Math.sqrt(j/Y),K=Math.round(A*k),q=Math.round(S*k),ct={maxHeight:8848,maxBuildingHeight:G,width:X,height:O,tileLatLngBounds:W,imageData:z,visibleDEMPixelBounds:L,raster:F,demZoom:v,dirty:!0,outputWidth:K,outputHeight:q},[3,5];case 4:return V=J.sent(),console.error("Could not decode height map",V),[3,5];case 5:return[2,ct]}var $,Q,tt,rt}))}))},ht=function(t,e){return[t.r/255,t.g/255,t.b/255,e]},pt=function(t,e){var r=e.date,n=nt(r),o=n.dec,i=n.Hi;t.updateDate({dec:o,Hi:i})},dt=function(t,e){return u(void 0,void 0,void 0,(function(){return s(this,(function(r){switch(r.label){case 0:return[4,t.updateDateRange(a({},e))];case 1:return[2,r.sent()]}}))}))},xt=function(t,e){var r=e.color,n=e.opacity,o=ht(r,n);t.updateColor({colorVec:o})};new g([0,0],[0,0]);var mt=function(t){var e=t.kernel,r=t.map,n=t.heightMap,o=t.now,i=t.color,u=t.opacity,s=t.maxZoom;try{var l=n.maxHeight,c=n.maxBuildingHeight,f=n.width,h=n.height,p=n.tileLatLngBounds,d=n.imageData,x=n.visibleDEMPixelBounds,m=n.demZoom;if(0===f||0===h)return;var _=x.min,v=x.max;if(!_||!v)return;var g=v.subtract(_).divideBy(m>s?Math.pow(2,m-s):1),y=g.x,E=g.y,T=r.project(p.getNorthWest(),m),w=_.divideBy(m>s?Math.pow(2,m-s):1).subtract(T),R=w.x,b=w.y,A=R/f,S=b/h,L=A+y/f,U=S+E/h,P=T.y/M/Math.pow(2,m),D=h/M/Math.pow(2,m),I=p.getWest(),C=Math.abs(p.getWest()-p.getEast())/f;!function(t,e){var r=e.color,n=e.opacity,o=e.date,i=e.imageData,u=e.maxBuildingHeight,s=ht(r,n),l=nt(o),c=l.dec,f=l.Hi;t.updateLocation(a({dec:c,Hi:f,colorVec:s,step:1},e)),ot(i).then((function(e){var r=e.maxHeight;t.updateMaxHeight({maxHeight:Math.max(r,u)})}))}(e,{imageData:d,maxHeight:l,maxBuildingHeight:c,width:f,height:h,date:o,heightMapZoom:m,mapZoom:r.getZoom(),xStart:A,yStart:S,xEnd:L,yEnd:U,topYCoord:P,ySize:D,color:i,opacity:u,west:I,dLng:C})}catch(t){console.error("EXCEPTION",t)}};var _t=function(t){var e=function(){return!t.getPitch};return{project:function(r,n){if(e())return t.project(r,n);var o=r.lat;return new d(function(t,e){return(t+180)/360*Math.pow(2,e)*M}(r.lng,n),function(t,e){return(1-Math.log(Math.tan(t*Math.PI/180)+1/Math.cos(t*Math.PI/180))/Math.PI)/2*Math.pow(2,e)*M}(o,n))},unproject:function(r,n){return e()?t.unproject(r,n):new T((o=r.y,i=n,a=Math.PI-2*Math.PI*o/M/Math.pow(2,i),180/Math.PI*Math.atan(.5*(Math.exp(a)-Math.exp(-a)))),function(t,e){return t/M/Math.pow(2,e)*360-180}(r.x,n));var o,i,a},getZoom:function(){return e()?t.getZoom():t.getZoom()+1},getCenter:function(){return t.getCenter()},getBounds:function(){return t.getBounds()},eachLayer:function(r){e()&&t.eachLayer(r)},getBearing:function(){return e()?0:t.getBearing()},getPitch:function(){return e()?0:t.getPitch()},rawMap:function(){return t},isLeaflet:e}};function vt(t){var e=this,r=t.context,n=function(t){var e=t.gl,r=t.vSrc,n=t.fSrc,o=e.createShader(e.VERTEX_SHADER);e.shaderSource(o,r),e.compileShader(o);var i=e.createShader(e.FRAGMENT_SHADER);e.shaderSource(i,n),e.compileShader(i);var a=e.createProgram();return e.attachShader(a,o),e.attachShader(a,i),e.linkProgram(a),e.getProgramParameter(a,e.LINK_STATUS)||(console.error("Link failed: "+e.getProgramInfoLog(a)),console.error("vs info-log: "+e.getShaderInfoLog(o)),console.error("fs info-log: "+e.getShaderInfoLog(i))),a}({gl:r,vSrc:"precision lowp float;precision lowp int;precision lowp sampler2D;attribute vec2 aPos;varying vec2 vTexCoordCropped;varying vec2 vTexCoordFull;varying vec2 vXSpace;varying vec2 vYSpace;uniform float user_xStart;uniform float user_yStart;uniform float user_xEnd;uniform float user_yEnd;void main(void){gl_Position=vec4(aPos,0,1);vec4 textureSpace=gl_Position*0.5+0.5;vTexCoordCropped=vec2((user_xEnd-user_xStart)*textureSpace.x+user_xStart,(user_yEnd-user_yStart)*(1.0-textureSpace.y)+user_yStart);vTexCoordFull=vec2(textureSpace);vXSpace=vec2(user_xStart,user_xEnd);vYSpace=vec2(user_yStart,user_yEnd);}",fSrc:"#ifdef GL_FRAGMENT_PRECISION_HIGH\nprecision highp float;\n#else\nprecision mediump float;\n#endif\nprecision lowp int;precision lowp sampler2D;float atan2(float v1,float v2){if(v1==0.0||v2==0.0)return 0.0;return atan(v1,v2);}float _pow(float v1,float v2){if(v2==0.0)return 1.0;return pow(v1,v2);}float integerMod(float x,float y){float res=floor(mod(x,y));return res*(res>floor(y)-1.0 ? 0.0 : 1.0);}float divWithIntCheck(float x,float y){if(floor(x)==x&&floor(y)==y&&integerMod(x,y)==0.0){return float(int(x)/int(y));}return x/y;}float integerCorrectionModulo(float number,float divisor){if(number<0.0){number=abs(number);if(divisor<0.0){divisor=abs(divisor);}return-(number-(divisor*floor(divWithIntCheck(number,divisor))));}if(divisor<0.0){divisor=abs(divisor);}return number-(divisor*floor(divWithIntCheck(number,divisor)));}float getElevationFromSampler2D(sampler2D tex,float x,float y){vec4 result=texture2D(tex,vec2(x,y));return(result.r*256.0*256.0+result.g*256.0)/5000.0;}vec4 actualColor;void color(float r,float g,float b,float a){actualColor=vec4(r,g,b,a);}void color(float r,float g,float b){color(r,g,b,1.0);}void color(float r){color(r,r,r,1.0);}void color(vec4 color){actualColor=color;}const int LOOP_MAX=1000;varying vec2 vTexCoordCropped;varying vec2 vTexCoordFull;uniform sampler2D user_a;uniform float user_width;uniform float user_height;uniform float user_maxHeight;uniform float user_zoom;uniform float user_topYCoord;uniform float user_ySize;uniform vec4 user_color;uniform vec4 u_sunColor;uniform float user_step;uniform float user_west;uniform float user_dLng;uniform float user_dec;uniform float user_Hi;uniform sampler2D user_sunExposureTexture;uniform bool user_renderToSunExposureTexture;uniform bool user_outputSunExposure;uniform vec4 user_exposureDelta;uniform bool u_outputShadeProfile;uniform sampler2D u_decHiTexture;uniform sampler2D u_gpxTexture;varying vec2 vXSpace;varying vec2 vYSpace;float kernelResult;void kernel(){float sunDec=user_dec;float sunHi=user_Hi;float maxHeight=user_maxHeight/1000.0;float user_x=vTexCoordCropped.x;float user_y=vTexCoordCropped.y;if(u_outputShadeProfile==true){vec4 decHi=texture2D(u_decHiTexture,vec2(.5,1.0-vTexCoordFull.y));sunDec=-decHi.r;sunHi=decHi.g*10.0;vec4 gpx=texture2D(u_gpxTexture,vec2(vTexCoordFull.x,.5));user_x=(vXSpace.y-vXSpace.x)*gpx.x+vXSpace.x;user_y=(vYSpace.y-vYSpace.x)*gpx.y+vYSpace.x;}float user_z=getElevationFromSampler2D(user_a,user_x,user_y);float user_PI=3.141592653589793;float user_2PI=6.283185307179586;float earthRadiusInKm=6378.137;float user_deg=57.29577951308232;float user_y_coord=user_topYCoord+(user_y*user_ySize);float user_lat_coord=(user_y_coord-0.5)/-0.15915494309189532;float user_lat=(2.0*atan(exp(user_lat_coord)))-(user_PI/2.0);float user_rad=0.017453292519943295;float user_lng=(user_west+(user_dLng*user_x*user_width));float user_H=integerCorrectionModulo((sunHi-(user_rad*-user_lng)),user_2PI);float sun_azimuth=atan2(sin(user_H),((cos(user_H)*sin(user_lat))-(tan(sunDec)*cos(user_lat))));float sun_altitude=asin(((sin(user_lat)*sin(sunDec))+((cos(user_lat)*cos(sunDec))*cos(user_H))));float user_zoom_factor=_pow(2.0,user_zoom);float user_kmPerPixel=divWithIntCheck(156.5430339296875,user_zoom_factor)*abs(cos(user_lat));float user_dx=((-sin(sun_azimuth)*cos(sun_altitude))*user_step)/user_width;float user_dy=((cos(sun_azimuth)*cos(sun_altitude))*user_step)/user_height;float user_dz=((sin(sun_altitude)*user_kmPerPixel)*user_step);float user_lit=1.0;float user_curvature=0.0;float cur_height=0.0;float user_distance=0.0;float user_startX=user_x;float user_startY=user_y;user_x+=user_dx;user_y+=user_dy;user_z+=user_dz;if((abs(1.0)<0.0)){kernelResult=0.0;return;}float minAngle=asin((earthRadiusInKm/(earthRadiusInKm+user_z)))-(user_PI/2.0);if(user_z<0.0||sun_altitude<minAngle){user_lit=0.0;}else{float xIter=ceil(user_dx<0.0 ? abs(user_x/user_dx):(1.0-user_x)/user_dx);float yIter=ceil(user_dy<0.0 ? abs(user_y/user_dy):(1.0-user_y)/user_dy);float zIter=ceil(user_dz<0.0 ? float(LOOP_MAX):(maxHeight-user_z)/user_dz);int iter=int(min(xIter,min(yIter,zIter)));float user_distance=(sqrt(pow(user_dx*user_width,2.0)+pow(user_dy*user_height,2.0))*user_kmPerPixel)/earthRadiusInKm;for(int safeI=0;safeI<LOOP_MAX;safeI++){if(safeI>iter){break;}cur_height=getElevationFromSampler2D(user_a,user_x,user_y);if(user_z<cur_height){user_curvature=earthRadiusInKm*(1.0-cos(user_distance*float(safeI+1)));if(user_z<(cur_height-user_curvature)){user_lit=0.0;iter=0;break;}}user_x+=user_dx;user_y+=user_dy;user_z+=user_dz;}}if((user_lit==1.0)){color(u_sunColor);}else{color(user_color);}if(user_renderToSunExposureTexture){vec4 aggregateColor=texture2D(user_sunExposureTexture,vec2(vTexCoordFull.x,vTexCoordFull.y));if((user_lit==1.0)){color(aggregateColor.r,0.0,0.0,1.0);}else{color(aggregateColor+user_exposureDelta);}if(user_outputSunExposure){float timeInSun=1.0-aggregateColor.r;float h=0.5;vec4 blue=vec4(0.0,0.0,1.0,1.0);vec4 green=vec4(0.0,1.0,0.0,1.0);vec4 red=vec4(1.0,0.0,0.0,1.0);vec4 col=mix(mix(blue,green,timeInSun/h),mix(green,red,(timeInSun-h)/(1.0-h)),step(h,timeInSun));color(col.r,col.g,col.b,0.5);}}}void main(void){kernel();gl_FragColor=actualColor;}"});r.useProgram(n);var o=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,o);var i=new Float32Array([-1,-1,1,-1,-1,1,1,1]);r.bufferData(r.ARRAY_BUFFER,i,r.STATIC_DRAW);var a=r.getAttribLocation(n,"aPos");r.enableVertexAttribArray(a),r.vertexAttribPointer(a,2,r.FLOAT,!1,0,0),r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA);var l=r.getUniformLocation(n,"user_a");r.uniform1i(l,0);var c=r.getUniformLocation(n,"user_width"),f=r.getUniformLocation(n,"user_height"),h=r.getUniformLocation(n,"user_maxHeight"),p=r.getUniformLocation(n,"user_zoom"),d=r.getUniformLocation(n,"user_topYCoord"),x=r.getUniformLocation(n,"user_ySize"),m=r.getUniformLocation(n,"user_step"),_=r.getUniformLocation(n,"user_west"),v=r.getUniformLocation(n,"user_dLng"),g=r.getUniformLocation(n,"user_dec"),y=r.getUniformLocation(n,"user_Hi"),E=r.getUniformLocation(n,"user_color"),T=r.getUniformLocation(n,"user_xStart"),w=r.getUniformLocation(n,"user_yStart"),R=r.getUniformLocation(n,"user_xEnd"),b=r.getUniformLocation(n,"user_yEnd"),M=r.getUniformLocation(n,"user_sunExposureTexture");r.uniform1i(M,2);var A=r.getUniformLocation(n,"user_renderToSunExposureTexture"),S=r.getUniformLocation(n,"user_outputSunExposure"),L=r.getUniformLocation(n,"user_exposureDelta"),U=r.getUniformLocation(n,"u_outputShadeProfile"),P=r.getUniformLocation(n,"u_gpxTexture"),D=r.getUniformLocation(n,"u_decHiTexture"),I=r.getUniformLocation(n,"u_sunColor"),C=function(){r.clear(r.COLOR_BUFFER_BIT),r.drawArrays(r.TRIANGLE_STRIP,0,4)},F=0;return{updateLocation:function(t){t.imageData;var e=t.width,i=t.height,u=t.maxHeight,s=t.heightMapZoom;t.mapZoom;var l=t.topYCoord,M=t.ySize,A=t.colorVec,S=t.step,L=t.west,U=t.dLng,P=t.dec,D=t.Hi,I=t.xStart,F=t.xEnd,B=t.yStart,N=t.yEnd;r.useProgram(n),r.bindFramebuffer(r.FRAMEBUFFER,null),r.bindBuffer(r.ARRAY_BUFFER,o),r.vertexAttribPointer(a,2,r.FLOAT,!1,0,0),r.uniform1f(c,e),r.uniform1f(f,i),r.uniform1f(h,u),r.uniform1f(p,s),r.uniform1f(d,l),r.uniform1f(x,M),r.uniform4fv(E,A),r.uniform1f(m,S),r.uniform1f(_,L),r.uniform1f(v,U),r.uniform1f(g,P),r.uniform1f(y,D),r.uniform1f(T,I),r.uniform1f(w,B),r.uniform1f(R,F),r.uniform1f(b,N),window.requestAnimationFrame(C)},updateViewport:function(t){var e=t.xStart,n=t.yStart,o=t.xEnd,i=t.yEnd;r.uniform1f(T,e),r.uniform1f(w,n),r.uniform1f(R,o),r.uniform1f(b,i),window.requestAnimationFrame(C)},updateDate:function(t){var e=t.dec,n=t.Hi;r.uniform1f(g,e),r.uniform1f(y,n),window.requestAnimationFrame(C)},updateDateRange:function(t){return u(e,void 0,void 0,(function(){var e,n,o,i,a,u,l,c,f,h,p,d,x,m,_;return s(this,(function(v){switch(v.label){case 0:e=t.start,n=t.end,o=t.emit,i=F=Date.now(),a=25,r.uniform4fv(L,new Float32Array([1/a,0,0,0])),u=Math.floor((n.getTime()-e.getTime())/a),l=r.canvas.width,c=r.canvas.height,f=r.createTexture(),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,f),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,l,c,0,r.RGBA,r.UNSIGNED_BYTE,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),h=r.createTexture(),r.activeTexture(r.TEXTURE2),r.bindTexture(r.TEXTURE_2D,h),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,l,c,0,r.RGBA,r.UNSIGNED_BYTE,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.uniform1i(A,1),p=r.createFramebuffer(),r.bindFramebuffer(r.FRAMEBUFFER,p),d=r.COLOR_ATTACHMENT0,r.viewport(0,0,l,c),x=function(t){return s(this,(function(n){switch(n.label){case 0:return o("tileloaded",t,a-1),i!==F?[2,{value:!0}]:[4,new Promise((function(n,o){window.requestAnimationFrame((function(){t%2==0?(r.uniform1i(M,2),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,f),r.framebufferTexture2D(r.FRAMEBUFFER,d,r.TEXTURE_2D,f,0)):(r.uniform1i(M,1),r.activeTexture(r.TEXTURE2),r.bindTexture(r.TEXTURE_2D,h),r.framebufferTexture2D(r.FRAMEBUFFER,d,r.TEXTURE_2D,h,0));var o=nt(new Date(e.getTime()+u*t)),i=o.dec,a=o.Hi;r.uniform1f(g,i),r.uniform1f(y,a),r.clear(r.COLOR_BUFFER_BIT),r.drawArrays(r.TRIANGLE_STRIP,0,4),n()}))}))];case 1:return n.sent(),[2]}}))},m=0,v.label=1;case 1:return m<a?[5,x(m)]:[3,4];case 2:if("object"==typeof(_=v.sent()))return[2,_.value];v.label=3;case 3:return m++,[3,1];case 4:return[4,new Promise((function(t,e){window.requestAnimationFrame((function(){i!==F&&t(!0),r.bindFramebuffer(r.FRAMEBUFFER,null),r.uniform1i(S,1),C(),r.uniform1i(A,0),r.uniform1i(S,0),r.deleteFramebuffer(p),r.deleteTexture(f),r.deleteTexture(h),t(!1)}))}))];case 5:return[2,v.sent()]}}))}))},updateColor:function(t){var e=t.colorVec;r.uniform4fv(E,e),window.requestAnimationFrame(C)},updateMaxHeight:function(t){var e=t.maxHeight;r.uniform1f(h,e)},generateShadeProfile:function(t){if(null===r.getExtension("OES_texture_float"))throw new Error("Float texture support required");var e=t.dates,o=t.pixels,i=t.shadeColor,a=t.sunColor;if(o.length%2!=0)throw new Error("Pixels array must have 2 numbers per coordinate");var u=o.map((function(t,e){return e%2==0?t/window.innerWidth:t/window.innerHeight})),s=o.length/2,l=e.length,c=r.getParameter(r.VIEWPORT),f=r.getUniform(n,E);r.uniform4fv(E,i),r.uniform4fv(I,a),r.uniform1i(U,1);var h=r.createTexture();r.activeTexture(r.TEXTURE2),r.bindTexture(r.TEXTURE_2D,h);var p=u.map((function(t,e){return e%2==0?t:[t,0,0]})).flat();r.texImage2D(r.TEXTURE_2D,0,r.RGBA,p.length/4,1,0,r.RGBA,r.FLOAT,new Float32Array(p)),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.uniform1i(P,2);var d=r.createTexture();r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,d);var x=e.map((function(t){var e=nt(t);return[-e.dec,e.Hi/10,0,0]})).flat();r.texImage2D(r.TEXTURE_2D,0,r.RGBA,1,e.length,0,r.RGBA,r.FLOAT,new Float32Array(x)),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.uniform1i(D,1),r.viewport(0,0,s,l),r.clear(r.COLOR_BUFFER_BIT),r.drawArrays(r.TRIANGLE_STRIP,0,4);var m=new Uint8Array(s*l*4);return r.readPixels(0,0,s,l,r.RGBA,r.UNSIGNED_BYTE,m),r.deleteTexture(d),r.deleteTexture(h),r.uniform1i(D,0),r.uniform1i(P,0),r.uniform1i(U,0),r.viewport(c[0],c[1],c[2],c[3]),r.uniform4fv(E,f),r.uniform4fv(I,[0,0,0,0]),m}}}var gt=function(t){function e(e){return t.call(this,e)||this}return i(e,t),e.prototype.addTo=function(t){return this.onAdd(t)},e.prototype.onAdd=function(t){if(this._map=t,!this._canvasOverlay&&this._canvas){var e=this._map.getBounds();this._canvasOverlay=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return new(c.bind.apply(c,l([void 0],t)))}(this._canvas,e),this._canvasOverlay.addTo(this._map)}return this._map.on("moveend",this._reset),this._reset(),this},e.prototype._repositionCanvas=function(t){this._canvasOverlay&&this._canvasOverlay.setBounds(t)},e}(function(t){function e(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];var o=t.call(this)||this;o.options={date:new Date,color:"000",opacity:.3,showExposure:!1,apiKey:"",terrainSource:{maxZoom:15,tileSize:256,getSourceUrl:function(t){return t.x,t.y,t.z,"https://s3.amazonaws.com/elevation-tiles-prod/terrarium/7/17/45.png"},getElevation:function(t){return 256*t.r+t.g+t.b/256-32768}},getFeatures:function(){return Promise.resolve([])},debug:function(t){}};var i=e[0];if(o.options=Object.assign(o.options,i),!o.options.apiKey)throw new Error("Could not load ShadeMap: apiKey missing");fetch("https://shademap.app/sdk/load",{method:"POST",body:JSON.stringify({api_key:o.options.apiKey}),headers:{"Content-Type":"application/json"}}).then((function(t){return u(o,void 0,void 0,(function(){var e;return s(this,(function(r){switch(r.label){case 0:return 200===t.status?[3,2]:(e=Error.bind,[4,t.text()]);case 1:throw new(e.apply(Error,[void 0,r.sent()]));case 2:return[2]}}))}))})).catch((function(t){return u(o,void 0,void 0,(function(){return s(this,(function(e){if(200!==t.status)throw new Error("Could not load ShadeMap API");return[2]}))}))})),o._suncalc=n.default||window.SunCalc;var a={preserveDrawingBuffer:!0,antialias:!1};return o._canvas=document.createElement("canvas"),o._gl=o._canvas.getContext("webgl",a)||o._canvas.getContext("experimental-webgl",a),o._compiledKernel=vt({context:o._gl}),o._color=o._parseColor(o.options.color),A(o._gl),o._reset=o._reset.bind(o),o._draw=o._draw.bind(o),o}return i(e,t),e.prototype.onRemove=function(){return this._map&&this._map.off("moveend",this._reset),this},e.prototype.setDate=function(t){return this.options.date.getTime()!==t.getTime()?(this.options.date=t,this._compiledKernel&&(pt(this._compiledKernel,{date:this.options.date}),this._flush())):this.emit("idle"),this},e.prototype.setColor=function(t){return this.options.color!==t&&(this.options.color=t,this._color=this._parseColor(this.options.color),this._compiledKernel&&(xt(this._compiledKernel,{color:this._color,opacity:this.options.opacity}),this._flush())),this},e.prototype.setOpacity=function(t){return this.options.opacity!==t&&(this.options.opacity=t,this._compiledKernel&&(xt(this._compiledKernel,{color:this._color,opacity:this.options.opacity}),this._flush())),this},e.prototype.setShowExposure=function(t){return u(this,void 0,void 0,(function(){var e,r,n,o;return s(this,(function(i){switch(i.label){case 0:if(!this._suncalc)throw new Error("Using sun exposure requires suncalc library");return this.options.showExposure===t?[3,4]:this._map&&this._compiledKernel?(this.options.showExposure=t,!0!==t?[3,2]:(e=_t(this._map).getCenter(),r=this._suncalc.getTimes(this.options.date,e.lat,e.lng),n=r.sunrise,o=r.sunset,[4,dt(this._compiledKernel,{start:n,end:o,emit:this.emit.bind(this)})])):[3,4];case 1:return!0===i.sent()?[2,this]:[3,3];case 2:pt(this._compiledKernel,{date:this.options.date}),i.label=3;case 3:this._flush(),i.label=4;case 4:return[2,this]}}))}))},e.prototype._resizeCanvas=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.options.debug("_resize w:"+t+" h:"+e),this._canvas.width=t,this._canvas.height=e,this._gl.viewport(0,0,t,e)},e.prototype._reset=function(){return u(this,void 0,void 0,(function(){var t,e,r=this;return s(this,(function(n){switch(n.label){case 0:if(this.options.debug("_reset()"),!this._map)return[3,2];t=_t(this._map);try{this._bounds=t.getBounds()}catch(t){return console.error("Invalid bounds returned: ",t),[2,this]}return[4,ft({gl:this._gl,map:t,bounds:this._bounds,terrainSource:this.options.terrainSource,getFeatures:this.options.getFeatures,tileLoaded:function(t,e){return r.emit("tileloaded",t,e)}})];case 1:(e=n.sent()).dirty&&(this._resizeCanvas(e.outputWidth,e.outputHeight),this._draw(e)),n.label=2;case 2:return[2,this]}}))}))},e.prototype._draw=function(t){var e=this;return this.options.debug("_draw()"),setTimeout((function(){return u(e,void 0,void 0,(function(){var e,r,n,o,i;return s(this,(function(a){switch(a.label){case 0:return this._canvas&&this._compiledKernel&&this._map?(mt({kernel:this._compiledKernel,map:_t(this._map),heightMap:t,color:this._color,opacity:this.options.opacity,now:this.options.date,maxZoom:this.options.terrainSource.maxZoom}),this.options.showExposure&&this._suncalc?(e=this._bounds.getEast(),r=this._bounds.getWest(),n=this._map.getCenter(),o=this._suncalc.getTimes(this.options.date,n.lat,e).sunrise,i=this._suncalc.getTimes(this.options.date,n.lat,r).sunset,[4,dt(this._compiledKernel,{start:o,end:i,emit:this.emit.bind(this)})]):[3,2]):[3,3];case 1:if(!0===a.sent())return[2,this];a.label=2;case 2:this._repositionCanvas(this._bounds),a.label=3;case 3:return[2]}}))}))}),0),this},e.prototype.readPixel=function(t,e){var r=new Uint8Array(4);return this._gl.readPixels(t,e,1,1,this._gl.RGBA,this._gl.UNSIGNED_BYTE,r),r},e.prototype._generateShadeProfile=function(t){if(this._compiledKernel){var e=this._parseColor(t.sunColor),r=this._parseColor(t.shadeColor);return function(t,e){var r=ht(e.shadeColor,1),n=ht(e.sunColor,1);return t.generateShadeProfile(a(a({},e),{sunColor:n,shadeColor:r}))}(this._compiledKernel,a(a({},t),{sunColor:e,shadeColor:r}))}},e.prototype.getHoursOfSun=function(t,e){if(this._map&&this.options.showExposure&&this._suncalc){var r=this.readPixel(t,e),n=r[0],o=r[2],i=0;i=n>0?n/255*.5+.5:o>0?.5*(1-o/255):.5;var a=_t(this._map).getCenter(),u=this._suncalc.getTimes(this.options.date,a.lat,a.lng),s=u.sunrise;return(u.sunset.getTime()-s.getTime())/1e3/3600*i}return 0},e.prototype._repositionCanvas=function(t){},e.prototype._flush=function(){},e.prototype.flushSync=function(){this._gl.finish()},e.prototype._parseColor=function(t){t=t.replace("#","");var e={r:0,g:0,b:0};return/^([0-9A-F]{3}){1,2}$/i.test(t)&&(3===t.length?(e.r=parseInt(t[0]+t[0],16),e.g=parseInt(t[1]+t[1],16),e.b=parseInt(t[2]+t[2],16)):6===t.length&&(e.r=parseInt(t[0]+t[1],16),e.g=parseInt(t[2]+t[3],16),e.b=parseInt(t[4]+t[5],16))),e},e}(S));return void 0!==window.L&&(window.L.shadeMap=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return new(gt.bind.apply(gt,l([void 0],t)))}),gt}));
