/**
 * Copyright Ted Piotrowski 2024
 * Package: leaflet-shadow-simulator
 * Version: 0.43.0
 * For licensing visit: https://shademap.app/about/
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("leaflet")):"function"==typeof define&&define.amd?define(["leaflet"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).ShadeMap=e(t.L)}(this,(function(t){"use strict";class e extends t.ImageOverlay{constructor(t,e,r={}){super("",e,r),this._url=t}_initImage(){const e="CANVAS"===this._url.tagName,r=this._image=e?this._url:t.DomUtil.create("canvas");return t.DomUtil.addClass(r,"leaflet-image-layer"),this._zoomAnimated&&t.DomUtil.addClass(r,"leaflet-zoom-animated"),this.options.className&&t.DomUtil.addClass(r,this.options.className),r.onselectstart=t.Util.falseFn,r.onmousemove=t.Util.falseFn,this}setBounds(t){return this._bounds=t,this._map&&this._reset(),this}}function r(t,e,r,n){return new(r||(r=Promise))((function(i,o){function s(t){try{u(n.next(t))}catch(t){o(t)}}function a(t){try{u(n.throw(t))}catch(t){o(t)}}function u(t){var e;t.done?i(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,a)}u((n=n.apply(t,e||[])).next())}))}function n(t,e,r){var n=e[1],i=e[0],o=n-i;return t===n&&r?t:((t-i)%o+o)%o+i}function i(t,e){if(!1===e)return t;var r=Math.pow(10,void 0===e?6:e);return Math.round(t*r)/r}var o=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)};function s(t,e,r){this.x=r?Math.round(t):t,this.y=r?Math.round(e):e}var a=Math.trunc||function(t){return t>0?Math.floor(t):Math.ceil(t)};function u(t,e,r){return t instanceof s?t:o(t)?new s(t[0],t[1]):null==t?t:"object"==typeof t&&"x"in t&&"y"in t?new s(t.x,t.y):new s(t,e,r)}function h(t,e){if(t)for(var r=e?[t,e]:t,n=0,i=r.length;n<i;n++)this.extend(r[n])}function l(t,e){return!t||t instanceof h?t:new h(t,e)}function c(t,e){if(t)for(var r=e?[t,e]:t,n=0,i=r.length;n<i;n++)this.extend(r[n])}function f(t,e){return t instanceof c?t:new c(t,e)}s.prototype={clone:function(){return new s(this.x,this.y)},add:function(t){return this.clone()._add(u(t))},_add:function(t){return this.x+=t.x,this.y+=t.y,this},subtract:function(t){return this.clone()._subtract(u(t))},_subtract:function(t){return this.x-=t.x,this.y-=t.y,this},divideBy:function(t){return this.clone()._divideBy(t)},_divideBy:function(t){return this.x/=t,this.y/=t,this},multiplyBy:function(t){return this.clone()._multiplyBy(t)},_multiplyBy:function(t){return this.x*=t,this.y*=t,this},scaleBy:function(t){return new s(this.x*t.x,this.y*t.y)},unscaleBy:function(t){return new s(this.x/t.x,this.y/t.y)},round:function(){return this.clone()._round()},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},floor:function(){return this.clone()._floor()},_floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},ceil:function(){return this.clone()._ceil()},_ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},trunc:function(){return this.clone()._trunc()},_trunc:function(){return this.x=a(this.x),this.y=a(this.y),this},distanceTo:function(t){var e=(t=u(t)).x-this.x,r=t.y-this.y;return Math.sqrt(e*e+r*r)},equals:function(t){return(t=u(t)).x===this.x&&t.y===this.y},contains:function(t){return t=u(t),Math.abs(t.x)<=Math.abs(this.x)&&Math.abs(t.y)<=Math.abs(this.y)},toString:function(){return"Point("+i(this.x)+", "+i(this.y)+")"}},h.prototype={extend:function(t){var e,r;if(!t)return this;if(t instanceof s||"number"==typeof t[0]||"x"in t)e=r=u(t);else if(e=(t=l(t)).min,r=t.max,!e||!r)return this;return this.min||this.max?(this.min.x=Math.min(e.x,this.min.x),this.max.x=Math.max(r.x,this.max.x),this.min.y=Math.min(e.y,this.min.y),this.max.y=Math.max(r.y,this.max.y)):(this.min=e.clone(),this.max=r.clone()),this},getCenter:function(t){return u((this.min.x+this.max.x)/2,(this.min.y+this.max.y)/2,t)},getBottomLeft:function(){return u(this.min.x,this.max.y)},getTopRight:function(){return u(this.max.x,this.min.y)},getTopLeft:function(){return this.min},getBottomRight:function(){return this.max},getSize:function(){return this.max.subtract(this.min)},contains:function(t){var e,r;return(t="number"==typeof t[0]||t instanceof s?u(t):l(t))instanceof h?(e=t.min,r=t.max):e=r=t,e.x>=this.min.x&&r.x<=this.max.x&&e.y>=this.min.y&&r.y<=this.max.y},intersects:function(t){t=l(t);var e=this.min,r=this.max,n=t.min,i=t.max,o=i.x>=e.x&&n.x<=r.x,s=i.y>=e.y&&n.y<=r.y;return o&&s},overlaps:function(t){t=l(t);var e=this.min,r=this.max,n=t.min,i=t.max,o=i.x>e.x&&n.x<r.x,s=i.y>e.y&&n.y<r.y;return o&&s},isValid:function(){return!(!this.min||!this.max)},pad:function(t){var e=this.min,r=this.max,n=Math.abs(e.x-r.x)*t,i=Math.abs(e.y-r.y)*t;return l(u(e.x-n,e.y-i),u(r.x+n,r.y+i))},equals:function(t){return!!t&&(t=l(t),this.min.equals(t.getTopLeft())&&this.max.equals(t.getBottomRight()))}},c.prototype={extend:function(t){var e,r,n=this._southWest,i=this._northEast;if(t instanceof m)e=t,r=t;else{if(!(t instanceof c))return t?this.extend(_(t)||f(t)):this;if(e=t._southWest,r=t._northEast,!e||!r)return this}return n||i?(n.lat=Math.min(e.lat,n.lat),n.lng=Math.min(e.lng,n.lng),i.lat=Math.max(r.lat,i.lat),i.lng=Math.max(r.lng,i.lng)):(this._southWest=new m(e.lat,e.lng),this._northEast=new m(r.lat,r.lng)),this},pad:function(t){var e=this._southWest,r=this._northEast,n=Math.abs(e.lat-r.lat)*t,i=Math.abs(e.lng-r.lng)*t;return new c(new m(e.lat-n,e.lng-i),new m(r.lat+n,r.lng+i))},getCenter:function(){return new m((this._southWest.lat+this._northEast.lat)/2,(this._southWest.lng+this._northEast.lng)/2)},getSouthWest:function(){return this._southWest},getNorthEast:function(){return this._northEast},getNorthWest:function(){return new m(this.getNorth(),this.getWest())},getSouthEast:function(){return new m(this.getSouth(),this.getEast())},getWest:function(){return this._southWest.lng},getSouth:function(){return this._southWest.lat},getEast:function(){return this._northEast.lng},getNorth:function(){return this._northEast.lat},contains:function(t){t="number"==typeof t[0]||t instanceof m||"lat"in t?_(t):f(t);var e,r,n=this._southWest,i=this._northEast;return t instanceof c?(e=t.getSouthWest(),r=t.getNorthEast()):e=r=t,e.lat>=n.lat&&r.lat<=i.lat&&e.lng>=n.lng&&r.lng<=i.lng},intersects:function(t){t=f(t);var e=this._southWest,r=this._northEast,n=t.getSouthWest(),i=t.getNorthEast(),o=i.lat>=e.lat&&n.lat<=r.lat,s=i.lng>=e.lng&&n.lng<=r.lng;return o&&s},overlaps:function(t){t=f(t);var e=this._southWest,r=this._northEast,n=t.getSouthWest(),i=t.getNorthEast(),o=i.lat>e.lat&&n.lat<r.lat,s=i.lng>e.lng&&n.lng<r.lng;return o&&s},toBBoxString:function(){return[this.getWest(),this.getSouth(),this.getEast(),this.getNorth()].join(",")},equals:function(t,e){return!!t&&(t=f(t),this._southWest.equals(t.getSouthWest(),e)&&this._northEast.equals(t.getNorthEast(),e))},isValid:function(){return!(!this._southWest||!this._northEast)}};var d=function(t){var e,r,n,i;for(r=1,n=arguments.length;r<n;r++)for(e in i=arguments[r])t[e]=i[e];return t}({},{latLngToPoint:function(t,e){var r=this.projection.project(t),n=this.scale(e);return this.transformation._transform(r,n)},pointToLatLng:function(t,e){var r=this.scale(e),n=this.transformation.untransform(t,r);return this.projection.unproject(n)},project:function(t){return this.projection.project(t)},unproject:function(t){return this.projection.unproject(t)},scale:function(t){return 256*Math.pow(2,t)},zoom:function(t){return Math.log(t/256)/Math.LN2},getProjectedBounds:function(t){if(this.infinite)return null;var e=this.projection.bounds,r=this.scale(t);return new h(this.transformation.transform(e.min,r),this.transformation.transform(e.max,r))},infinite:!1,wrapLatLng:function(t){var e=this.wrapLng?n(t.lng,this.wrapLng,!0):t.lng;return new m(this.wrapLat?n(t.lat,this.wrapLat,!0):t.lat,e,t.alt)},wrapLatLngBounds:function(t){var e=t.getCenter(),r=this.wrapLatLng(e),n=e.lat-r.lat,i=e.lng-r.lng;if(0===n&&0===i)return t;var o=t.getSouthWest(),s=t.getNorthEast();return new c(new m(o.lat-n,o.lng-i),new m(s.lat-n,s.lng-i))}},{wrapLng:[-180,180],R:6371e3,distance:function(t,e){var r=Math.PI/180,n=t.lat*r,i=e.lat*r,o=Math.sin((e.lat-t.lat)*r/2),s=Math.sin((e.lng-t.lng)*r/2),a=o*o+Math.cos(n)*Math.cos(i)*s*s,u=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));return this.R*u}});function m(t,e,r){if(isNaN(t)||isNaN(e))throw new Error("Invalid LatLng object: ("+t+", "+e+")");this.lat=+t,this.lng=+e,void 0!==r&&(this.alt=+r)}function _(t,e,r){return t instanceof m?t:o(t)&&"object"!=typeof t[0]?3===t.length?new m(t[0],t[1],t[2]):2===t.length?new m(t[0],t[1]):null:null==t?t:"object"==typeof t&&"lat"in t?new m(t.lat,"lng"in t?t.lng:t.lon,t.alt):void 0===e?null:new m(t,e,r)}m.prototype={equals:function(t,e){return!!t&&(t=_(t),Math.max(Math.abs(this.lat-t.lat),Math.abs(this.lng-t.lng))<=(void 0===e?1e-9:e))},toString:function(t){return"LatLng("+i(this.lat,t)+", "+i(this.lng,t)+")"},distanceTo:function(t){return d.distance(this,_(t))},wrap:function(){return d.wrapLatLng(this)},toBounds:function(t){var e=180*t/40075017,r=e/Math.cos(Math.PI/180*this.lat);return f([this.lat-e,this.lng-r],[this.lat+e,this.lng+r])},clone:function(){return new m(this.lat,this.lng,this.alt)}};const x=8848,g=256;const p=(t,e)=>{const{lat:r,lng:n}=t;return new s(((t,e)=>(t+180)/360*Math.pow(2,e)*g)(n,e),((t,e)=>(1-Math.log(Math.tan(t*Math.PI/180)+1/Math.cos(t*Math.PI/180))/Math.PI)/2*Math.pow(2,e)*g)(r,e))},E=(t,e)=>{return new m((r=t.y,n=e,i=Math.PI-2*Math.PI*r/g/Math.pow(2,n),180/Math.PI*Math.atan(.5*(Math.exp(i)-Math.exp(-i)))),function(t,e){return t/g/Math.pow(2,e)*360-180}(t.x,e));var r,n,i},T=.40909994067971484,v=t=>{const e=t.valueOf()/864e5-10957.5,r=6.240059966692059+.017201969994578018*e,n=r+.017453292519943295*(1.9148*Math.sin(r)+.02*Math.sin(2*r)+3e-4*Math.sin(3*r))+1.796593062783907+Math.PI,i=Math.atan2(Math.sin(n)*Math.cos(T),Math.cos(n));return{dec:Math.asin(Math.sin(T)*Math.sin(n)),Hi:(4.889714432387314+6.3003876824396166*e-i)%(2*Math.PI)+2*Math.PI}},y=(t,e,r)=>{const n=1/e,i=Math.min(t[0]*n,255),o=Math.min(t[1]*n,255),s=Math.min(t[2]*n,255);let a=0;return i+o+s!==0&&(a=i>0?i/255*.5+.5:s>0?.5*(1-s/255):.5),a*r},R=(t=new Date,e)=>{const r=new Date(t.toLocaleString("en-US",{timeZone:"UTC"})),n=new Date(t.toLocaleString("en-US",e?{timeZone:e}:{}));return r.getTime()-n.getTime()};function A(t){const{gl:e,vSrc:r,fSrc:n}=t,i=e.createShader(e.VERTEX_SHADER);e.shaderSource(i,r),e.compileShader(i);const o=e.createShader(e.FRAGMENT_SHADER);e.shaderSource(o,n),e.compileShader(o);const s=e.createProgram();return e.attachShader(s,i),e.attachShader(s,o),e.linkProgram(s),s}class w{constructor(t){this.gl=t,this.program=A({gl:t,vSrc:"\nuniform vec3 xyz;\nuniform vec2 dimensions;\nuniform bool use_dsm;\nattribute vec2 dsm_position;\nattribute vec2 a_position;\nfloat PI = 3.141592653589793;\nvarying vec2 vCoord;\n\n\tvoid main() {\n\t\tif (use_dsm == true) {\n\t\t\tgl_Position = vec4(a_position, 0, 1);\n\t\t\tvCoord = dsm_position;\n\t\t\treturn;\n\t\t}\n\t\tif (abs(a_position) == vec2(1,1)) {\n\t\t\tgl_Position = vec4(a_position, 0, 1);\n\t\t\tvCoord = a_position * 0.5 + 0.5;\n\t\t\treturn;\n\t\t}\n\t\tfloat x = ((a_position.x + 180.0) / 360.0 * pow(2.0, xyz.z)) * 256.0 - xyz.x;\n\t\tfloat y = (1.0 - (log(a_position.y) / PI)) / 2.0 * pow(2.0, xyz.z) * 256.0 - xyz.y;\n\t\tvec2 transformed = vec2(x, y);\n\t\tvec2 normalized = transformed / dimensions;\n\t\tvec2 final = normalized * 2.0 - 1.0;\n\t\tgl_Position = vec4(final, 0, 1);\n\t}\n",fSrc:"\n#ifdef GL_FRAGMENT_PRECISION_HIGH\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\nuniform vec4 color;\nuniform sampler2D height_map;\nvarying vec2 vCoord;\n\nvoid main() {\n\tif (color == vec4(0,0,0,0)) {\n\t \tvec4 textureColor = texture2D(height_map, vec2(vCoord.x, vCoord.y));\n\t \tgl_FragColor = vec4(textureColor.b, textureColor.a, 0, 1.0);\n\t\treturn;\n\t} \n\tgl_FragColor = color;\n}\n"}),this.positionAttributeLocation=t.getAttribLocation(this.program,"a_position"),this.dsmAttributeLocation=t.getAttribLocation(this.program,"dsm_position"),this.useDSMUniformLocation=t.getUniformLocation(this.program,"use_dsm"),this.xyzUniformLocation=t.getUniformLocation(this.program,"xyz"),this.dimensionsUniformLocation=t.getUniformLocation(this.program,"dimensions"),this.heightMapUniformLocation=t.getUniformLocation(this.program,"height_map"),this.colorUniformLocation=t.getUniformLocation(this.program,"color"),this.positionBuffer=t.createBuffer(),this.dsmBuffer=t.createBuffer(),this.indexBuffer=t.createBuffer(),this.targetTexture=t.createTexture()}raster(t){const{features:e,upperLeftTile:r,mapZoom:n,width:i,height:o,imageData:a,dsmCoords:u,dsmSource:h,gl:l}=t,{x:c,y:f,z:d}=r;let m=0;l.useProgram(this.program),l.activeTexture(l.TEXTURE1);const _=l.createTexture();l.bindTexture(l.TEXTURE_2D,_),l.pixelStorei(l.UNPACK_ALIGNMENT,2),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,l.NEAREST),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,l.NEAREST),l.texImage2D(l.TEXTURE_2D,0,l.LUMINANCE_ALPHA,i,o,0,l.LUMINANCE_ALPHA,l.UNSIGNED_BYTE,a);const x=i,E=o;l.activeTexture(l.TEXTURE0),l.bindTexture(l.TEXTURE_2D,this.targetTexture),l.texImage2D(l.TEXTURE_2D,0,l.RGBA,x,E,0,l.RGBA,l.UNSIGNED_BYTE,null),n>15&&e.length>5?(l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,l.NEAREST),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,l.NEAREST)):(l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,l.LINEAR),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,l.LINEAR)),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),l.viewport(0,0,x,E);const T=l.createFramebuffer();l.bindFramebuffer(l.FRAMEBUFFER,T);const v=l.COLOR_ATTACHMENT0;l.framebufferTexture2D(l.FRAMEBUFFER,v,l.TEXTURE_2D,this.targetTexture,0),l.bindBuffer(l.ARRAY_BUFFER,this.positionBuffer),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,this.indexBuffer),l.clearColor(0,0,0,0),l.clear(l.COLOR_BUFFER_BIT);const y=c*g,R=f*g,A=new s(y,R);l.uniform3f(this.xyzUniformLocation,y,R,d),l.uniform2f(this.dimensionsUniformLocation,i,o),l.uniform1i(this.heightMapUniformLocation,1),l.uniform1i(this.useDSMUniformLocation,0);const w=new Float32Array([-1,-1,1,-1,-1,1,1,1]);if(l.enableVertexAttribArray(this.positionAttributeLocation),l.bufferData(l.ARRAY_BUFFER,w,l.STATIC_DRAW),l.vertexAttribPointer(this.positionAttributeLocation,2,l.FLOAT,!1,0,0),l.uniform4f(this.colorUniformLocation,0,0,0,0),l.drawArrays(l.TRIANGLE_STRIP,0,4),e.forEach((t=>{const{buildingHeight:e,aPosition:r,cuts:n,centroid:s,highlight:u}=t,h=p({lng:s[0],lat:s[1]},d).subtract(A).floor();if(h.x<0||h.y<0||h.x>i||h.y>o)return;const c=256*a[h.y*i*2+2*h.x]+a[h.y*i*2+2*h.x+1]+5*e,f=Math.floor(c/256)/256,_=Math.floor(c%256)/256;m=Math.max(m,c/5),l.uniform4f(this.colorUniformLocation,f,_,u?1:0,1),l.bufferData(l.ARRAY_BUFFER,r,l.DYNAMIC_DRAW),l.vertexAttribPointer(this.positionAttributeLocation,2,l.FLOAT,!1,0,0),l.bufferData(l.ARRAY_BUFFER,r,l.DYNAMIC_DRAW),l.vertexAttribPointer(this.dsmAttributeLocation,2,l.FLOAT,!1,0,0),l.bufferData(l.ELEMENT_ARRAY_BUFFER,n,l.DYNAMIC_DRAW),l.drawElements(l.TRIANGLES,n.length,n.length>256?l.UNSIGNED_SHORT:l.UNSIGNED_BYTE,0)})),l.deleteTexture(_),0!==h.data.length){l.activeTexture(l.TEXTURE1);const t=l.createTexture();l.bindTexture(l.TEXTURE_2D,t),l.pixelStorei(l.UNPACK_ALIGNMENT,2),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,l.NEAREST),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,l.NEAREST),l.texImage2D(l.TEXTURE_2D,0,l.LUMINANCE_ALPHA,h.width,h.height,0,l.LUMINANCE_ALPHA,l.UNSIGNED_BYTE,h.data);const e=[u[0],u[3],u[2],u[3],u[0],u[1],u[2],u[1]],r=new Float32Array(e);l.enableVertexAttribArray(this.positionAttributeLocation),l.bufferData(l.ARRAY_BUFFER,r,l.STATIC_DRAW),l.vertexAttribPointer(this.positionAttributeLocation,2,l.FLOAT,!1,0,0),l.enableVertexAttribArray(this.dsmAttributeLocation),l.bindBuffer(l.ARRAY_BUFFER,this.dsmBuffer),l.bufferData(l.ARRAY_BUFFER,new Float32Array([0,1,1,1,0,0,1,0]),l.STATIC_DRAW),l.vertexAttribPointer(this.dsmAttributeLocation,2,l.FLOAT,!1,0,0),l.uniform4f(this.colorUniformLocation,0,0,0,0),l.uniform1i(this.useDSMUniformLocation,1),l.drawArrays(l.TRIANGLE_STRIP,0,4),l.deleteTexture(t)}return l.deleteFramebuffer(T),m}}function M(t,e,r){r=r||2;var n,i,o,s,a,u,h,l=e&&e.length,c=l?e[0]*r:t.length,f=b(t,0,c,r,!0),d=[];if(!f||f.next===f.prev)return d;if(l&&(f=function(t,e,r,n){var i,o,s,a=[];for(i=0,o=e.length;i<o;i++)(s=b(t,e[i]*n,i<o-1?e[i+1]*n:t.length,n,!1))===s.next&&(s.steiner=!0),a.push(X(s));for(a.sort(C),i=0;i<a.length;i++)r=F(a[i],r);return r}(t,e,f,r)),t.length>80*r){n=o=t[0],i=s=t[1];for(var m=r;m<c;m+=r)(a=t[m])<n&&(n=a),(u=t[m+1])<i&&(i=u),a>o&&(o=a),u>s&&(s=u);h=0!==(h=Math.max(o-n,s-i))?32767/h:0}return D(f,d,r,n,i,h,0),d}function b(t,e,r,n,i){var o,s;if(i===$(t,e,r,n)>0)for(o=e;o<r;o+=n)s=q(o,t[o],t[o+1],s);else for(o=r-n;o>=e;o-=n)s=q(o,t[o],t[o+1],s);return s&&H(s,s.next)&&(k(s),s=s.next),s}function U(t,e){if(!t)return t;e||(e=t);var r,n=t;do{if(r=!1,n.steiner||!H(n,n.next)&&0!==G(n.prev,n,n.next))n=n.next;else{if(k(n),(n=e=n.prev)===n.next)break;r=!0}}while(r||n!==e);return e}function D(t,e,r,n,i,o,s){if(t){!s&&o&&function(t,e,r,n){var i=t;do{0===i.z&&(i.z=N(i.x,i.y,e,r,n)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==t);i.prevZ.nextZ=null,i.prevZ=null,function(t){var e,r,n,i,o,s,a,u,h=1;do{for(r=t,t=null,o=null,s=0;r;){for(s++,n=r,a=0,e=0;e<h&&(a++,n=n.nextZ);e++);for(u=h;a>0||u>0&&n;)0!==a&&(0===u||!n||r.z<=n.z)?(i=r,r=r.nextZ,a--):(i=n,n=n.nextZ,u--),o?o.nextZ=i:t=i,i.prevZ=o,o=i;r=n}o.nextZ=null,h*=2}while(s>1)}(i)}(t,n,i,o);for(var a,u,h=t;t.prev!==t.next;)if(a=t.prev,u=t.next,o?P(t,n,i,o):L(t))e.push(a.i/r|0),e.push(t.i/r|0),e.push(u.i/r|0),k(t),t=u.next,h=u.next;else if((t=u)===h){s?1===s?D(t=S(U(t),e,r),e,r,n,i,o,2):2===s&&I(t,e,r,n,i,o):D(U(t),e,r,n,i,o,1);break}}}function L(t){var e=t.prev,r=t,n=t.next;if(G(e,r,n)>=0)return!1;for(var i=e.x,o=r.x,s=n.x,a=e.y,u=r.y,h=n.y,l=i<o?i<s?i:s:o<s?o:s,c=a<u?a<h?a:h:u<h?u:h,f=i>o?i>s?i:s:o>s?o:s,d=a>u?a>h?a:h:u>h?u:h,m=n.next;m!==e;){if(m.x>=l&&m.x<=f&&m.y>=c&&m.y<=d&&O(i,a,o,u,s,h,m.x,m.y)&&G(m.prev,m,m.next)>=0)return!1;m=m.next}return!0}function P(t,e,r,n){var i=t.prev,o=t,s=t.next;if(G(i,o,s)>=0)return!1;for(var a=i.x,u=o.x,h=s.x,l=i.y,c=o.y,f=s.y,d=a<u?a<h?a:h:u<h?u:h,m=l<c?l<f?l:f:c<f?c:f,_=a>u?a>h?a:h:u>h?u:h,x=l>c?l>f?l:f:c>f?c:f,g=N(d,m,e,r,n),p=N(_,x,e,r,n),E=t.prevZ,T=t.nextZ;E&&E.z>=g&&T&&T.z<=p;){if(E.x>=d&&E.x<=_&&E.y>=m&&E.y<=x&&E!==i&&E!==s&&O(a,l,u,c,h,f,E.x,E.y)&&G(E.prev,E,E.next)>=0)return!1;if(E=E.prevZ,T.x>=d&&T.x<=_&&T.y>=m&&T.y<=x&&T!==i&&T!==s&&O(a,l,u,c,h,f,T.x,T.y)&&G(T.prev,T,T.next)>=0)return!1;T=T.nextZ}for(;E&&E.z>=g;){if(E.x>=d&&E.x<=_&&E.y>=m&&E.y<=x&&E!==i&&E!==s&&O(a,l,u,c,h,f,E.x,E.y)&&G(E.prev,E,E.next)>=0)return!1;E=E.prevZ}for(;T&&T.z<=p;){if(T.x>=d&&T.x<=_&&T.y>=m&&T.y<=x&&T!==i&&T!==s&&O(a,l,u,c,h,f,T.x,T.y)&&G(T.prev,T,T.next)>=0)return!1;T=T.nextZ}return!0}function S(t,e,r){var n=t;do{var i=n.prev,o=n.next.next;!H(i,o)&&W(i,n,n.next,o)&&Y(i,o)&&Y(o,i)&&(e.push(i.i/r|0),e.push(n.i/r|0),e.push(o.i/r|0),k(n),k(n.next),n=t=o),n=n.next}while(n!==t);return U(n)}function I(t,e,r,n,i,o){var s=t;do{for(var a=s.next.next;a!==s.prev;){if(s.i!==a.i&&z(s,a)){var u=K(s,a);return s=U(s,s.next),u=U(u,u.next),D(s,e,r,n,i,o,0),void D(u,e,r,n,i,o,0)}a=a.next}s=s.next}while(s!==t)}function C(t,e){return t.x-e.x}function F(t,e){var r=function(t,e){var r,n=e,i=t.x,o=t.y,s=-1/0;do{if(o<=n.y&&o>=n.next.y&&n.next.y!==n.y){var a=n.x+(o-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(a<=i&&a>s&&(s=a,r=n.x<n.next.x?n:n.next,a===i))return r}n=n.next}while(n!==e);if(!r)return null;var u,h=r,l=r.x,c=r.y,f=1/0;n=r;do{i>=n.x&&n.x>=l&&i!==n.x&&O(o<c?i:s,o,l,c,o<c?s:i,o,n.x,n.y)&&(u=Math.abs(o-n.y)/(i-n.x),Y(n,t)&&(u<f||u===f&&(n.x>r.x||n.x===r.x&&B(r,n)))&&(r=n,f=u)),n=n.next}while(n!==h);return r}(t,e);if(!r)return e;var n=K(r,t);return U(n,n.next),U(r,r.next)}function B(t,e){return G(t.prev,t,e.prev)<0&&G(e.next,t,t.next)<0}function N(t,e,r,n,i){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-r)*i|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-n)*i|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function X(t){var e=t,r=t;do{(e.x<r.x||e.x===r.x&&e.y<r.y)&&(r=e),e=e.next}while(e!==t);return r}function O(t,e,r,n,i,o,s,a){return(i-s)*(e-a)>=(t-s)*(o-a)&&(t-s)*(n-a)>=(r-s)*(e-a)&&(r-s)*(o-a)>=(i-s)*(n-a)}function z(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var r=t;do{if(r.i!==t.i&&r.next.i!==t.i&&r.i!==e.i&&r.next.i!==e.i&&W(r,r.next,t,e))return!0;r=r.next}while(r!==t);return!1}(t,e)&&(Y(t,e)&&Y(e,t)&&function(t,e){var r=t,n=!1,i=(t.x+e.x)/2,o=(t.y+e.y)/2;do{r.y>o!=r.next.y>o&&r.next.y!==r.y&&i<(r.next.x-r.x)*(o-r.y)/(r.next.y-r.y)+r.x&&(n=!n),r=r.next}while(r!==t);return n}(t,e)&&(G(t.prev,t,e.prev)||G(t,e.prev,e))||H(t,e)&&G(t.prev,t,t.next)>0&&G(e.prev,e,e.next)>0)}function G(t,e,r){return(e.y-t.y)*(r.x-e.x)-(e.x-t.x)*(r.y-e.y)}function H(t,e){return t.x===e.x&&t.y===e.y}function W(t,e,r,n){var i=Z(G(t,e,r)),o=Z(G(t,e,n)),s=Z(G(r,n,t)),a=Z(G(r,n,e));return i!==o&&s!==a||(!(0!==i||!j(t,r,e))||(!(0!==o||!j(t,n,e))||(!(0!==s||!j(r,t,n))||!(0!==a||!j(r,e,n)))))}function j(t,e,r){return e.x<=Math.max(t.x,r.x)&&e.x>=Math.min(t.x,r.x)&&e.y<=Math.max(t.y,r.y)&&e.y>=Math.min(t.y,r.y)}function Z(t){return t>0?1:t<0?-1:0}function Y(t,e){return G(t.prev,t,t.next)<0?G(t,e,t.next)>=0&&G(t,t.prev,e)>=0:G(t,e,t.prev)<0||G(t,t.next,e)<0}function K(t,e){var r=new V(t.i,t.x,t.y),n=new V(e.i,e.x,e.y),i=t.next,o=e.prev;return t.next=e,e.prev=t,r.next=i,i.prev=r,n.next=r,r.prev=n,o.next=n,n.prev=o,n}function q(t,e,r,n){var i=new V(t,e,r);return n?(i.next=n.next,i.prev=n,n.next.prev=i,n.next=i):(i.prev=i,i.next=i),i}function k(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function V(t,e,r){this.i=t,this.x=e,this.y=r,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function $(t,e,r,n){for(var i=0,o=e,s=r-n;o<r;o+=n)i+=(t[s]-t[o])*(t[o+1]+t[s+1]),s=o;return i}function J(t){t.filter((t=>"MultiPolygon"===t.geometry.type)).forEach((e=>{const{geometry:r,properties:n,type:i}=e;if("MultiPolygon"===r.type)for(let n=0;n<r.coordinates.length;n++)t.push(Object.assign(Object.assign({},e),{geometry:Object.assign(Object.assign({},r),{type:"Polygon",coordinates:r.coordinates[n]})}))}));return t.filter((t=>"Polygon"===t.geometry.type)).map((t=>{const{geometry:e,properties:r}=t,{vertices:n}=M.flatten(e.coordinates),i=new Float32Array(n.map(((t,e)=>{if(e%2==1){const e=t*Math.PI/180;return Math.tan(e)+1/Math.cos(e)}return t}))),o=M(n),s=o.length>256?new Uint16Array(o):new Uint8Array(o),a=function(t){const{height:e=0,levels:r=0,render_height:n=0}=t;if(r)return 3.04*r;return Math.max(e,n)}(r),u=r.highlight||!1;let h=0,l=0,c=0;for(let t=0;t<n.length;t+=2)h+=n[t],l+=n[t+1],c++;return{aPosition:i,cuts:s,buildingHeight:a,centroid:[h/c,l/c],highlight:u}}))}M.deviation=function(t,e,r,n){var i=e&&e.length,o=i?e[0]*r:t.length,s=Math.abs($(t,0,o,r));if(i)for(var a=0,u=e.length;a<u;a++){var h=e[a]*r,l=a<u-1?e[a+1]*r:t.length;s-=Math.abs($(t,h,l,r))}var c=0;for(a=0;a<n.length;a+=3){var f=n[a]*r,d=n[a+1]*r,m=n[a+2]*r;c+=Math.abs((t[f]-t[m])*(t[d+1]-t[f+1])-(t[f]-t[d])*(t[m+1]-t[f+1]))}return 0===s&&0===c?0:Math.abs((c-s)/s)},M.flatten=function(t){for(var e=t[0][0].length,r={vertices:[],holes:[],dimensions:e},n=0,i=0;i<t.length;i++){for(var o=0;o<t[i].length;o++)for(var s=0;s<e;s++)r.vertices.push(t[i][o][s]);i>0&&(n+=t[i-1].length,r.holes.push(n))}return r};const Q=t=>new Promise(((e,r)=>{const n=new Int32Array(t.buffer).reduce(((t,e)=>Math.max(t,(t=>{const e=(256*(255&t)+(t>>8&255))/5,r=(256*(t>>16&255)+(t>>24&255))/5;return Math.max(e,r)})(e))),0);e({maxHeight:Math.min(x,n)})}));let tt,et={width:0,height:0,imageData:new Uint8ClampedArray(0),visibleDEMPixelBounds:new h(new s(0,0),new s(0,0)),DEMPixelBounds:new h(new s(0,0),new s(0,0)),maxHeight:x,maxBuildingHeight:0,raster:[],demZoom:0,dirty:!1,outputWidth:0,outputHeight:0};const rt=t=>r(void 0,void 0,void 0,(function*(){const{demZoom:e,getFeatures:n,terrainSource:i,dsmSource:o,tileLoaded:a,gl:u,bounds:l,buildingRasterizer:f,tileMerger:d,forceUpdate:m=!1}=t,{getSourceUrl:_,getElevation:E,maxZoom:T,tileSize:v,_overzoom:y}=i,R=(A={getFeatures:n},r(void 0,void 0,void 0,(function*(){const{getFeatures:t}=A;try{return J(yield t())}catch(t){console.log("Error merging buildings",t)}return[]})));var A;try{const t=l,r=t.getNorthWest(),n=t.getSouthEast(),i=new h(p(r,e),p(n,e));let y=new s(i.min.x,i.min.y),A=i.max.x-i.min.x;const w=i.max.y-i.min.y,M=i.max.subtract(i.min);M.y>M.x&&(y.x-=g,A+=512);const b=(t=>{const{upperLeft:e,width:r,height:n}=t,i=e.divideBy(g).floor().multiplyBy(g),o=(Math.ceil(r/g)+1)*g,s=(Math.ceil(n/g)+1)*g,a=i.add([o,s]);return new h(i,a)})({upperLeft:y,width:A,height:w}),{x:U,y:D}=b.max.subtract(b.min),L=(t=>{t.sort(((t,e)=>t.y!==e.y?t.y-e.y:t.x-e.x));const e=t.reduce(((t,e)=>e.x<t.x?e:t)).x,r=t.reduce(((t,e)=>e.y<t.y?e:t)).y;return t.map((t=>{const n=Math.pow(2,t.z);return{x:(t.x%n+n)%n,y:(t.y%n+n)%n,z:t.z,xOffset:(t.x-e)*g,yOffset:(t.y-r)*g}}))})((t=>{const{upperLeft:e,width:r,height:n,zoom:i}=t,o=e.divideBy(g).floor(),s=o.x+r/g,a=Math.min(o.y+n/g,Math.pow(2,i)-1),u=[];for(var h=o.x;h<s;h++)for(var l=o.y;l<a;l++)u.push({x:h,y:l,z:i});return u})({upperLeft:b.min,width:U,height:D,zoom:e})),P=i.max.x-i.min.x,S=i.max.y-i.min.y,I=P,C=S,F=JSON.stringify(L);if(!m&&F===tt&&e<T)return et=Object.assign(Object.assign({},et),{outputWidth:I,outputHeight:C,visibleDEMPixelBounds:i,demZoom:e,dirty:!0}),et;const B=yield d.merge(L,{maxZoom:T,width:U,height:D,crossOrigin:"Anonymous",getSourceUrl:_,getElevation:E,tileSize:v,tileLoaded:a});if(null===B)return et=Object.assign(Object.assign({},et),{visibleDEMPixelBounds:i,demZoom:e,dirty:!1}),et;const N=new h(p(new c(o.bounds).getNorthWest(),e),p(new c(o.bounds).getSouthEast(),e)),X=N.min.subtract(b.min),O=N.max.subtract(b.min),z=[X.x/U,X.y/D,O.x/U,O.y/D].map((t=>2*t-1));let G=0;const H=yield R;G=f.raster({upperLeftTile:L[0],width:U,height:D,mapZoom:e,features:H,imageData:B,gl:u,dsmSource:o,dsmCoords:z}),G=Math.max(o.maxHeight,G);tt=F,et={maxHeight:x,maxBuildingHeight:G,width:U,height:D,imageData:B,DEMPixelBounds:b,visibleDEMPixelBounds:i,raster:L,demZoom:e,dirty:!0,outputWidth:I,outputHeight:C}}catch(t){console.error("Could not decode height map",t)}return et})),nt=t=>{const{tile:e,maxZoom:r,tileSize:n}=t;let{x:i,y:o,z:s}=e;if(s>r){const t=Math.pow(2,e.z-r);i=Math.floor(i/t),o=Math.floor(o/t),s=r}return{x:n===g?i:Math.floor(i/2),y:n===g?o:Math.floor(o/2),z:n===g?s:s-1}};class it{constructor(){this.canvas=document.createElement("canvas"),this.canvas.width=g,this.canvas.height=g,this.ctx=this.canvas.getContext("2d",{antialias:!1,alpha:!1,willReadFrequently:!0}),null!==this.ctx&&(this.ctx.imageSmoothingEnabled=!1),this.inProgress=[],this.finished=0}merge(t,e){return r(this,void 0,void 0,(function*(){const{width:n,height:i,crossOrigin:o,getSourceUrl:s,getElevation:a,tileSize:u,tileLoaded:h,maxZoom:l}=e;if(this.ctx){const e=new Uint8ClampedArray(2*n*i);this.inProgress.forEach((t=>t.src="")),this.inProgress=[],this.finished=0;const c=new Set;t.forEach((t=>{c.add(s(nt({tile:t,maxZoom:l,tileSize:u})))}));const f=Array.from(c).map((i=>r(this,void 0,void 0,(function*(){return new Promise(((r,h)=>{const c=new Image;this.inProgress.push(c),c.onload=()=>{t.filter((t=>i===s(nt({tile:t,maxZoom:l,tileSize:u})))).forEach((t=>{let r=0,i=0;const o=514===u?1:0;let s=0,h=g,f=g;if(u!==g&&(r=t.x%2*g,i=t.y%2*g,h=g,f=g),t.z>l){const e=Math.pow(2,t.z-l);u!==g&&(r=Math.floor(t.x/e)%2*g,i=Math.floor(t.y/e)%2*g),r+=g*(t.x%e/e),i+=g*(t.y%e/e),h=g/e,f=g/e,s=514===u?1:0}this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(c,o+r,o+i,h+s,f+s,0,0,h+s,f+s);const d=this.ctx.getImageData(0,0,h+s,f+s).data,m=new Uint8ClampedArray(131072);let _=new Array((h+s)*(f+s)),x=g/h;for(let t=0;t<d.length;t+=4){const e=5*(a({r:d[t],g:d[t+1],b:d[t+2],a:d[t+3]})||0);_[t/4]=e}if(x>1&&514===u)for(_=function(t,e,r,n){const i=Math.floor(e*n),o=Math.floor(r*n),s=[];for(let a=0;a<o;a++)for(let o=0;o<i;o++){const i=o/n,u=a/n,h=Math.floor(i),l=Math.floor(u),c=Math.min(h+1,e-1),f=Math.min(l+1,r-1),d=i-h,m=u-l,_=l*e+c,x=f*e+h,g=f*e+c,p=t[l*e+h]*(1-d)*(1-m)+t[_]*d*(1-m)+t[x]*(1-d)*m+t[g]*d*m;s.push(p)}return function(t,e,r,n,i){if(n>=e||i>=r)return[];const o=e-n,s=r-i,a=[];for(let r=0;r<s;r++)for(let n=0;n<o;n++){const i=r*e+n;a.push(t[i])}return a}(s,Math.sqrt(s.length),Math.sqrt(s.length),n,n)}(_,h+1,f+1,x);x>1;)x/=2,f*=2,h*=2;for(let t=0;t<m.length;t+=2){const e=_[Math.floor(t/2/g/x)*h+Math.floor(t/2%g/x)],r=Math.floor(e/256),n=Math.floor(e%256);m[t]=r,m[t+1]=n}for(let r=0;r<g;r++)e.set(m.slice(r*g*2,(r+1)*g*2),2*(t.yOffset*n+r*n+t.xOffset))})),r(null)},c.onerror=t=>{if(c.src!==c.originalSource)return h("new tiles requested");r(null)},c.crossOrigin=o||null,c.src=i,c.originalSource=c.src})).then((()=>{this.finished++,h(this.finished,this.inProgress.length)}))}))));try{yield Promise.all(f)}catch(t){return console.log(`${f.length} requests aborted`,t),null}return this.inProgress=[],e}throw new Error("Could not get canvas context for merging tile images")}))}}const ot=(t,e)=>{const{r:r,g:n,b:i}=t;return[r/255,n/255,i/255,e]},st=(t,e)=>{const{date:r}=e,{dec:n,Hi:i}=v(r);t.updateDate({dec:n,Hi:i})},at=(t,e)=>r(void 0,void 0,void 0,(function*(){return yield t.updateDateRange(Object.assign({},e))})),ut=(t,e)=>{const{color:r,opacity:n}=e,i=ot(r,n);t.updateColor({colorVec:i})};new c([0,0],[0,0]);const ht=t=>{const{kernel:e,map:r,heightMap:n,now:i,color:o,opacity:s}=t;try{const{outputHeight:t,outputWidth:a,maxHeight:u,maxBuildingHeight:h,width:l,height:f,DEMPixelBounds:d,imageData:m,visibleDEMPixelBounds:_,demZoom:x}=n;if(0===l||0===f)return;const{min:p,max:T}=_;if(!p||!T)return;const{x:y,y:R}=T.subtract(p),A=d.min,w=r.getPixelDimensions(),M=r.screenUnproject([0,0]),b=r.screenUnproject([w.width,0]),U=r.screenUnproject([w.width,w.height]),D=r.screenUnproject([0,w.height]),L=[D,U,M,b].map((t=>r.project(t,x))),P=L.map((t=>[(t.x-A.x)/l,(t.y-A.y)/f])).flat(),S=L.map((t=>[(t.x-p.x)/y,(t.y-p.y)/R])).map((t=>[2*t[0]-1,-1*(2*t[1]-1)])).flat(),I=A.y/g/Math.pow(2,x),C=f/g/Math.pow(2,x),F=new c(E(d.getTopLeft(),x),E(d.getBottomRight(),x)),B=F.getWest(),N=Math.abs(F.getWest()-F.getEast());((t,e)=>{const{color:r,opacity:n,date:i,imageData:o,maxBuildingHeight:s}=e,a=ot(r,n),{dec:u,Hi:h}=v(i);t.updateLocation(Object.assign({dec:u,Hi:h,colorVec:a,step:1},e)),Q(o).then((({maxHeight:e})=>{t.updateMaxHeight({maxHeight:Math.max(e,s)})}))})(e,{imageData:m,maxHeight:u,maxBuildingHeight:h,width:l,height:f,heightMapZoom:x,cornerTextureCoords:P,cornerClipCoords:S,topYCoord:I,ySize:C,west:B,dLng:N,date:i,color:o,opacity:s,outputHeight:t,outputWidth:a})}catch(t){console.error("EXCEPTION",t)}};const lt=t=>{const e=()=>!t.getPitch;return{project:(r,n)=>{if(e())return t.project(r,n);{const{lat:t,lng:e}=r;return new s(((t,e)=>(t+180)/360*Math.pow(2,e)*g)(e,n),((t,e)=>(1-Math.log(Math.tan(t*Math.PI/180)+1/Math.cos(t*Math.PI/180))/Math.PI)/2*Math.pow(2,e)*g)(t,n))}},unproject:(r,n)=>{return e()?t.unproject(r,n):new m((i=r.y,o=n,s=Math.PI-2*Math.PI*i/g/Math.pow(2,o),180/Math.PI*Math.atan(.5*(Math.exp(s)-Math.exp(-s)))),function(t,e){return t/g/Math.pow(2,e)*360-180}(r.x,n));var i,o,s},screenUnproject:r=>e()?t.containerPointToLatLng(r):t.unproject(r),getZoom:()=>e()?t.getZoom():t.getZoom()+1,getCenter:()=>t.getCenter(),getBounds:()=>t.getBounds(),eachLayer:r=>{e()&&t.eachLayer(r)},getBearing:()=>e()?0:t.getBearing(),getPitch:()=>e()?0:t.getPitch(),rawMap:()=>t,isLeaflet:e,getPixelDimensions:()=>{const e=t.getContainer();return{width:e.clientWidth,height:e.clientHeight}},createBounds:t=>{const{nw:e,se:r}=t;return new c(e,r)}}};class ct extends class extends class{constructor(){this.events={}}on(t,e){return"object"!=typeof this.events[t]&&(this.events[t]=[]),this.events[t].push(e),()=>this.removeListener(t,e)}removeListener(t,e){if("object"!=typeof this.events[t])return;const r=this.events[t].indexOf(e);r>-1&&this.events[t].splice(r,1)}removeAllListeners(){Object.keys(this.events).forEach((t=>this.events[t].splice(0,this.events[t].length)))}emit(t,...e){"object"==typeof this.events[t]&&[...this.events[t]].forEach((t=>t.apply(this,e)))}once(t,e){const r=this.on(t,((...t)=>{r(),e.apply(this,t)}));return r}}{constructor(...t){super(),this.options={date:new Date,color:"000",opacity:.3,sunExposure:{enabled:!1,startDate:new Date,endDate:new Date,iterations:32},apiKey:"",terrainSource:{maxZoom:15,tileSize:256,_overzoom:15,getSourceUrl:t=>"https://s3.amazonaws.com/elevation-tiles-prod/terrarium/7/17/45.png",getElevation:t=>{const{r:e,g:r,b:n}=t;return 256*e+r+n/256-32768}},dsmSource:{bounds:[{lat:0,lng:0},{lat:0,lng:0}],data:new Uint8ClampedArray,width:0,height:0,maxHeight:0},getFeatures:()=>Promise.resolve([]),getSize:()=>({width:Number.NaN,height:Number.NaN}),debug:t=>{}};const e=t[0];if(this.options=Object.assign(this.options,e),!this.options.apiKey)throw new Error("Could not load ShadeMap: apiKey missing");fetch("https://shademap.app/sdk/load",{method:"POST",body:JSON.stringify({api_key:this.options.apiKey}),headers:{"Content-Type":"application/json"}}).then((t=>r(this,void 0,void 0,(function*(){if(200!==t.status)throw new Error(yield t.text())})))).catch((t=>r(this,void 0,void 0,(function*(){throw new Error(`Could not load ShadeMap API. Key: ${this.options.apiKey} Error: ${t}`)}))));const n={preserveDrawingBuffer:!0,antialias:!1};this._canvas=document.createElement("canvas"),this._gl=this._canvas.getContext("webgl",n)||this._canvas.getContext("experimental-webgl",n),this._compiledKernel=function(t){const{context:e}=t,n=e,i=A({gl:n,vSrc:"precision lowp float;precision lowp int;precision lowp sampler2D;attribute vec2 a_pos;attribute vec2 a_tex_pos;varying vec2 vTexCoordCropped;varying vec2 vTexCoordFull;void main(void){gl_Position=vec4(a_pos,0,1);vTexCoordFull=(gl_Position*0.5+0.5).xy;vTexCoordCropped=a_tex_pos;}",fSrc:"#ifdef GL_FRAGMENT_PRECISION_HIGH\nprecision highp float;\n#else\nprecision mediump float;\n#endif\nprecision lowp int;precision lowp sampler2D;float atan2(float v1,float v2){if(v1==0.0||v2==0.0)return 0.0;return atan(v1,v2);}float _pow(float v1,float v2){if(v2==0.0)return 1.0;return pow(v1,v2);}float integerMod(float x,float y){float res=floor(mod(x,y));return res*(res>floor(y)-1.0 ? 0.0 : 1.0);}float divWithIntCheck(float x,float y){if(floor(x)==x&&floor(y)==y&&integerMod(x,y)==0.0){return float(int(x)/int(y));}return x/y;}float integerCorrectionModulo(float number,float divisor){if(number<0.0){number=abs(number);if(divisor<0.0){divisor=abs(divisor);}return-(number-(divisor*floor(divWithIntCheck(number,divisor))));}if(divisor<0.0){divisor=abs(divisor);}return number-(divisor*floor(divWithIntCheck(number,divisor)));}float getElevationFromSampler2D(sampler2D tex,float x,float y){vec4 result=texture2D(tex,vec2(x,y));return(result.r*256.0*256.0+result.g*256.0)/5000.0;}vec4 actualColor;void color(float r,float g,float b,float a){actualColor=vec4(r,g,b,a);}void color(float r,float g,float b){color(r,g,b,1.0);}void color(float r){color(r,r,r,1.0);}void color(vec4 color){actualColor=color;}const int LOOP_MAX=1000;varying vec2 vTexCoordCropped;varying vec2 vTexCoordFull;uniform sampler2D user_a;uniform float user_width;uniform float user_height;uniform float user_maxHeight;uniform float user_zoom;uniform float user_topYCoord;uniform float user_ySize;uniform vec4 user_color;uniform vec4 u_sunColor;uniform float user_step;uniform float user_west;uniform float user_dLng;uniform float user_dec;uniform float user_Hi;uniform sampler2D user_sunExposureTexture;uniform bool user_renderToSunExposureTexture;uniform bool user_outputSunExposure;uniform vec4 user_exposureDelta;uniform bool u_outputShadeProfile;uniform sampler2D u_decHiTexture;uniform sampler2D u_gpxTexture;uniform bool u_outputLocationShadeProfile;uniform vec2 u_shadeProfileLocation;float kernelResult;void kernel(){float sunDec=user_dec;float sunHi=user_Hi;vec4 shade_color=user_color;float maxHeight=user_maxHeight/1000.0;float user_x=vTexCoordCropped.x;float user_y=vTexCoordCropped.y;if(u_outputShadeProfile==true){vec4 decHi=texture2D(u_decHiTexture,vec2(vTexCoordFull.x,1.0-vTexCoordFull.y));sunDec=-decHi.r;sunHi=decHi.g*10.0;vec4 gpx=texture2D(u_gpxTexture,vec2(vTexCoordFull.x,.5));user_x=gpx.x;user_y=gpx.y;}if(u_outputLocationShadeProfile==true){vec4 decHi=texture2D(u_decHiTexture,vec2(vTexCoordFull.x,1.0-vTexCoordFull.y));sunDec=-decHi.r;sunHi=decHi.g*10.0;user_x=u_shadeProfileLocation.x;user_y=u_shadeProfileLocation.y;}float user_z=getElevationFromSampler2D(user_a,user_x,user_y);float user_PI=3.141592653589793;float user_2PI=6.283185307179586;float earthRadiusInKm=6378.137;float user_deg=57.29577951308232;float user_y_coord=user_topYCoord+(user_y*user_ySize);float user_lat_coord=(user_y_coord-0.5)/-0.15915494309189532;float user_lat=(2.0*atan(exp(user_lat_coord)))-(user_PI/2.0);float user_rad=0.017453292519943295;float user_lng=user_west+(user_dLng*user_x);float user_H=integerCorrectionModulo((sunHi-(user_rad*-user_lng)),user_2PI);float sun_azimuth=atan2(sin(user_H),((cos(user_H)*sin(user_lat))-(tan(sunDec)*cos(user_lat))));float sun_altitude=asin(((sin(user_lat)*sin(sunDec))+((cos(user_lat)*cos(sunDec))*cos(user_H))));float user_zoom_factor=_pow(2.0,user_zoom);float user_kmPerPixel=divWithIntCheck(156.5430339296875,user_zoom_factor)*abs(cos(user_lat));float user_dx=((-sin(sun_azimuth)*cos(sun_altitude))*user_step)/user_width;float user_dy=((cos(sun_azimuth)*cos(sun_altitude))*user_step)/user_height;float user_dz=((sin(sun_altitude)*user_kmPerPixel)*user_step);float shadow_bias=0.0005;float user_lit=1.0;float user_curvature=0.0;float cur_height=0.0;float user_distance=0.0;float user_startX=user_x;float user_startY=user_y;user_x+=user_dx;user_y+=user_dy;user_z+=user_dz;if((abs(1.0)<0.0)){kernelResult=0.0;return;}float minAngle=asin((earthRadiusInKm/(earthRadiusInKm+user_z)))-(user_PI/2.0);if(user_z<0.0||sun_altitude<minAngle){user_lit=0.0;}else{float xIter=ceil(user_dx<0.0 ? abs(user_x/user_dx):(1.0-user_x)/user_dx);float yIter=ceil(user_dy<0.0 ? abs(user_y/user_dy):(1.0-user_y)/user_dy);float zIter=ceil(user_dz<0.0 ? float(LOOP_MAX):(maxHeight-user_z)/user_dz);int iter=int(min(xIter,min(yIter,zIter)));float user_distance=(sqrt(pow(user_dx*user_width,2.0)+pow(user_dy*user_height,2.0))*user_kmPerPixel)/earthRadiusInKm;for(int safeI=0;safeI<LOOP_MAX;safeI++){if(safeI>iter){break;}cur_height=getElevationFromSampler2D(user_a,user_x,user_y);if(cur_height-user_z>shadow_bias){user_curvature=earthRadiusInKm*(1.0-cos(user_distance*float(safeI+1)));if(user_z<(cur_height-user_curvature)){user_lit=0.0;vec4 result=texture2D(user_a,vec2(user_x,user_y));if(result.z==1.0){shade_color=vec4(.92941,.4375,.078125,.85);}iter=0;break;}}user_x+=user_dx;user_y+=user_dy;user_z+=user_dz;}}if((user_lit==1.0)){if(u_outputLocationShadeProfile==true&&u_sunColor==shade_color){float timeInSun=pow(.7,pow(sin(sun_altitude),.678))*sin(sun_altitude)*(1.0/0.7);float h=0.5;vec4 blue=vec4(0.0,0.0,1.0,1.0);vec4 green=vec4(0.0,1.0,0.0,1.0);vec4 red=vec4(1.0,0.0,0.0,1.0);vec4 col=mix(mix(blue,green,timeInSun/h),mix(green,red,(timeInSun-h)/(1.0-h)),step(h,timeInSun));color(col.r,col.g,col.b,1.0);}else{color(u_sunColor);}}else{color(shade_color);}if(user_renderToSunExposureTexture){vec4 aggregateColor=texture2D(user_sunExposureTexture,vec2(vTexCoordFull.x,vTexCoordFull.y));if((user_lit==1.0)){color(aggregateColor.r,0.0,0.0,1.0);}else{color(aggregateColor.r+user_exposureDelta.r,0.0,0.0,1.0);}if(user_outputSunExposure){float timeInSun=1.0-aggregateColor.r;float h=0.5;vec4 blue=vec4(0.0,0.0,1.0,1.0);vec4 green=vec4(0.0,1.0,0.0,1.0);vec4 red=vec4(1.0,0.0,0.0,1.0);vec4 col=mix(mix(blue,green,timeInSun/h),mix(green,red,(timeInSun-h)/(1.0-h)),step(h,timeInSun));color(col.r,col.g,col.b,0.5);}}}void main(void){kernel();gl_FragColor=actualColor;}"});n.useProgram(i);const o=n.createBuffer(),s=n.getAttribLocation(i,"a_pos"),a=n.createBuffer(),u=n.getAttribLocation(i,"a_tex_pos"),h=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,h),n.bufferData(n.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),n.STATIC_DRAW),n.enable(n.BLEND),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA);const l=n.getUniformLocation(i,"user_a");n.uniform1i(l,0);const c=n.getUniformLocation(i,"user_width"),f=n.getUniformLocation(i,"user_height"),d=n.getUniformLocation(i,"user_maxHeight"),m=n.getUniformLocation(i,"user_zoom"),_=n.getUniformLocation(i,"user_topYCoord"),x=n.getUniformLocation(i,"user_ySize"),g=n.getUniformLocation(i,"user_step"),p=n.getUniformLocation(i,"user_west"),E=n.getUniformLocation(i,"user_dLng"),T=n.getUniformLocation(i,"user_dec"),y=n.getUniformLocation(i,"user_Hi"),R=n.getUniformLocation(i,"user_color"),w=n.getUniformLocation(i,"user_xStart"),M=n.getUniformLocation(i,"user_yStart"),b=n.getUniformLocation(i,"user_xEnd"),U=n.getUniformLocation(i,"user_yEnd"),D=n.getUniformLocation(i,"user_sunExposureTexture");n.uniform1i(D,2);const L=n.getUniformLocation(i,"user_renderToSunExposureTexture"),P=n.getUniformLocation(i,"user_outputSunExposure"),S=n.getUniformLocation(i,"user_exposureDelta"),I=n.getUniformLocation(i,"u_outputShadeProfile"),C=n.getUniformLocation(i,"u_gpxTexture"),F=n.getUniformLocation(i,"u_decHiTexture"),B=n.getUniformLocation(i,"u_sunColor"),N=n.getUniformLocation(i,"u_outputLocationShadeProfile"),X=n.getUniformLocation(i,"u_shadeProfileLocation"),O=()=>{n.clear(n.COLOR_BUFFER_BIT),n.drawArrays(n.TRIANGLE_STRIP,0,4)};let z=0;return{updateLocation:function(t){const{width:e,height:r,maxHeight:h,heightMapZoom:l,topYCoord:v,ySize:A,colorVec:w,step:M,west:b,dLng:U,dec:D,Hi:L,cornerClipCoords:P,cornerTextureCoords:S,outputWidth:I,outputHeight:C}=t;n.useProgram(i),n.canvas.width=I,n.canvas.height=C,n.viewport(0,0,I,C),n.bindFramebuffer(n.FRAMEBUFFER,null),n.bindBuffer(n.ARRAY_BUFFER,o),n.bufferData(n.ARRAY_BUFFER,new Float32Array(P),n.STATIC_DRAW),n.enableVertexAttribArray(s),n.vertexAttribPointer(s,2,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,a),n.bufferData(n.ARRAY_BUFFER,new Float32Array(S),n.STATIC_DRAW),n.enableVertexAttribArray(u),n.vertexAttribPointer(u,2,n.FLOAT,!1,0,0),n.uniform1f(c,e),n.uniform1f(f,r),n.uniform1f(d,h),n.uniform1f(m,l),n.uniform1f(_,v),n.uniform1f(x,A),n.uniform4fv(R,w),n.uniform1f(g,M),n.uniform1f(p,b),n.uniform1f(E,U),n.uniform1f(T,D),n.uniform1f(y,L),window.requestAnimationFrame(O)},updateViewport:function(t){const{xStart:e,yStart:r,xEnd:i,yEnd:o}=t;n.uniform1f(w,e),n.uniform1f(M,r),n.uniform1f(b,i),n.uniform1f(U,o),window.requestAnimationFrame(O)},updateDate:t=>{const{dec:e,Hi:r}=t;n.uniform1f(T,e),n.uniform1f(y,r),window.requestAnimationFrame(O)},updateDateRange:t=>r(this,void 0,void 0,(function*(){const{startDate:e,endDate:r,iterations:i,emit:o}=t,s=z=Date.now();n.uniform4fv(S,new Float32Array([1/i,0,0,0]));const a=Math.floor((r.getTime()-e.getTime())/i),u=n.canvas.width,h=n.canvas.height,l=n.createTexture();n.activeTexture(n.TEXTURE1),n.bindTexture(n.TEXTURE_2D,l),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,u,h,0,n.RGBA,n.UNSIGNED_BYTE,null),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR);const c=n.createTexture();n.activeTexture(n.TEXTURE2),n.bindTexture(n.TEXTURE_2D,c),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,u,h,0,n.RGBA,n.UNSIGNED_BYTE,null),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.uniform1i(L,1);const f=n.createFramebuffer();n.bindFramebuffer(n.FRAMEBUFFER,f);const d=n.COLOR_ATTACHMENT0;n.viewport(0,0,u,h);for(let t=0;t<i;t++){if(o("tileloaded",t,i-1),s!==z)return!0;yield new Promise(((r,i)=>{window.requestAnimationFrame((()=>{t%2==0?(n.uniform1i(D,2),n.activeTexture(n.TEXTURE1),n.bindTexture(n.TEXTURE_2D,l),n.framebufferTexture2D(n.FRAMEBUFFER,d,n.TEXTURE_2D,l,0)):(n.uniform1i(D,1),n.activeTexture(n.TEXTURE2),n.bindTexture(n.TEXTURE_2D,c),n.framebufferTexture2D(n.FRAMEBUFFER,d,n.TEXTURE_2D,c,0));const{dec:i,Hi:o}=v(new Date(e.getTime()+a*t));n.uniform1f(T,i),n.uniform1f(y,o),n.clear(n.COLOR_BUFFER_BIT),n.drawArrays(n.TRIANGLE_STRIP,0,4),r()}))}))}return yield new Promise(((t,e)=>{window.requestAnimationFrame((()=>{s!==z&&t(!0),n.bindFramebuffer(n.FRAMEBUFFER,null),n.uniform1i(D,i%2==0?2:1),n.uniform1i(P,1),O(),n.uniform1i(L,0),n.uniform1i(P,0),n.deleteFramebuffer(f),n.deleteTexture(l),n.deleteTexture(c),t(!1)}))}))})),updateColor:t=>{const{colorVec:e}=t;n.uniform4fv(R,e),window.requestAnimationFrame(O)},updateMaxHeight:t=>{const{maxHeight:e}=t;n.uniform1f(d,e)},generateShadeProfile:t=>{if(null===n.getExtension("OES_texture_float"))throw new Error("Float texture support required");const{dates:e,texCoords:r,shadeColor:a,sunColor:u}=t,l=r.length,c=e.length,f=n.getParameter(n.VIEWPORT),d=n.getUniform(i,R);n.uniform4fv(R,a),n.uniform4fv(B,u),n.uniform1i(I,1);const m=n.createTexture();n.activeTexture(n.TEXTURE2),n.bindTexture(n.TEXTURE_2D,m);const _=r.map((t=>[t[0],t[1],0,0])).flat();n.texImage2D(n.TEXTURE_2D,0,n.RGBA,_.length/4,1,0,n.RGBA,n.FLOAT,new Float32Array(_)),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.uniform1i(C,2);const x=n.createTexture();n.activeTexture(n.TEXTURE1),n.bindTexture(n.TEXTURE_2D,x);const g=e.map((t=>{const{dec:e,Hi:r}=v(t);return[-e,r/10,0,0]})).flat();n.texImage2D(n.TEXTURE_2D,0,n.RGBA,1,e.length,0,n.RGBA,n.FLOAT,new Float32Array(g)),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.uniform1i(F,1),n.viewport(0,0,l,c),n.clear(n.COLOR_BUFFER_BIT),n.bindBuffer(n.ARRAY_BUFFER,h),n.enableVertexAttribArray(s),n.vertexAttribPointer(s,2,n.FLOAT,!1,0,0),n.drawArrays(n.TRIANGLE_STRIP,0,4),n.bindBuffer(n.ARRAY_BUFFER,o),n.vertexAttribPointer(s,2,n.FLOAT,!1,0,0);const p=new Uint8Array(l*c*4);return n.readPixels(0,0,l,c,n.RGBA,n.UNSIGNED_BYTE,p),n.deleteTexture(x),n.deleteTexture(m),n.uniform1i(F,0),n.uniform1i(C,0),n.uniform1i(I,0),n.viewport(f[0],f[1],f[2],f[3]),n.uniform4fv(R,d),n.uniform4fv(B,[0,0,0,0]),p},generateLocationShadeProfile:t=>{if(null===n.getExtension("OES_texture_float"))throw new Error("Float texture support required");const{dates:e,texCoord:r,shadeColor:a,sunColor:u}=t,l=e[0].length,c=e.length,f=n.getParameter(n.VIEWPORT),d=n.getUniform(i,R);n.uniform4fv(R,a),n.uniform4fv(B,u),n.uniform1i(N,1),n.uniform2fv(X,[r[0],r[1]]);const m=n.createTexture();n.activeTexture(n.TEXTURE1),n.bindTexture(n.TEXTURE_2D,m);const _=e.flat().map((t=>{const{dec:e,Hi:r}=v(t);return[-e,r/10,0,0]})).flat();n.texImage2D(n.TEXTURE_2D,0,n.RGBA,l,c,0,n.RGBA,n.FLOAT,new Float32Array(_)),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.uniform1i(F,1),n.viewport(0,0,l,c),n.clear(n.COLOR_BUFFER_BIT),n.bindBuffer(n.ARRAY_BUFFER,h),n.enableVertexAttribArray(s),n.vertexAttribPointer(s,2,n.FLOAT,!1,0,0),n.drawArrays(n.TRIANGLE_STRIP,0,4),n.bindBuffer(n.ARRAY_BUFFER,o),n.vertexAttribPointer(s,2,n.FLOAT,!1,0,0);const x=new Uint8Array(l*c*4);return n.readPixels(0,0,l,c,n.RGBA,n.UNSIGNED_BYTE,x),n.deleteTexture(m),n.uniform1i(F,0),n.uniform1i(N,0),n.viewport(f[0],f[1],f[2],f[3]),n.uniform4fv(R,d),n.uniform4fv(B,[0,0,0,0]),x}}}({context:this._gl}),this._color=this._parseColor(this.options.color),this._buildingRasterizer=new w(this._gl),this._tileMerger=new it,this._reset=this._reset.bind(this),this._draw=this._draw.bind(this)}onRemove(){return this._map&&this._map.off("moveend",this._reset),this}setDate(t){return this.options.date.getTime()!==t.getTime()?(this.options.date=t,this._compiledKernel&&(st(this._compiledKernel,{date:this.options.date}),this._flush())):this.emit("idle"),this}_setDateForTimezone(t,e){let r=0;e&&(r=R(this.options.date)-R(this.options.date,e)),this.setDate(new Date(t.getTime()-r))}setColor(t){return this.options.color!==t&&(this.options.color=t,this._color=this._parseColor(this.options.color),this._compiledKernel&&(ut(this._compiledKernel,{color:this._color,opacity:this.options.opacity}),this._flush())),this}setOpacity(t){return this.options.opacity!==t&&(this.options.opacity=t,this._compiledKernel&&(ut(this._compiledKernel,{color:this._color,opacity:this.options.opacity}),this._flush())),this}setTerrainSource(t){return this.options.terrainSource=t,delete this._heightMap,this._reset(),this}setDSMSource(t){return this.options.dsmSource=t,delete this._heightMap,this._reset(),this}setSunExposure(t=!1,e){return r(this,void 0,void 0,(function*(){if(this._map&&this._compiledKernel){if(!1===t)this.options.sunExposure=Object.assign(Object.assign({},this.options.sunExposure),{enabled:t}),st(this._compiledKernel,{date:this.options.date});else{const{startDate:r,endDate:n,iterations:i=32}=e;if(this.options.sunExposure={enabled:t,startDate:r,endDate:n,iterations:i},!(r instanceof Date&&n instanceof Date))throw new Error("Start date or end date or both are missing");if(n.getTime()<r.getTime())throw new Error("End date must come after the start date to calculate sun exposure");if(!0===(yield at(this._compiledKernel,{startDate:r,endDate:n,iterations:i,emit:this.emit.bind(this)})))return this}this._flush()}return this}))}_lngLatToTextureCoords(t){if(this._heightMap){const{DEMPixelBounds:e,demZoom:r,width:n,height:i}=this._heightMap,o=e.min;return t.map((t=>{const e=p(t,r);return[(e.x-o.x)/n,(e.y-o.y)/i]}))}return[]}_getBounds(t,e){const{width:r,height:n}=this.options.getSize();if(Number.isNaN(r)||Number.isNaN(n))return t.getBounds();const i=t.getCenter(),o=p(i,e),a=E(new s(o.x-r/2,o.y-n/2),e),u=E(new s(o.x+r/2,o.y+n/2),e);return t.createBounds({nw:a,se:u})}_getDEMZoom(t){const e=Math.min(this.options.terrainSource._overzoom||this.options.terrainSource.maxZoom,t.getZoom());return Math.round(e)}_reset(){return r(this,void 0,void 0,(function*(){if(this.options.debug("_reset()"),this._map){const t=lt(this._map);let e=this._getDEMZoom(t);try{this._bounds=this._getBounds(t,e)}catch(t){return console.error("Invalid bounds returned: ",t),this}try{if(!t.isLeaflet()&&this._map.getPitch()>45){yield new Promise((t=>{this._map.loaded()?t(!0):this._map.once("idle",(function(){t(!0)}))}));const r=this._map.style._sourceCaches["other:composite"].getVisibleCoordinates().reverse(),n=r.reduce(((t,e)=>Math.max(t,e.canonical.z)),Number.MIN_SAFE_INTEGER),i=r.filter((t=>t.canonical.z===n)).map((t=>t.canonical)),[o,a,u,h]=i.reduce(((t,e)=>[Math.min(t[0],e.x),Math.min(t[1],e.y),Math.max(t[2],e.x),Math.max(t[3],e.y)]),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,Number.MIN_SAFE_INTEGER,Number.MIN_SAFE_INTEGER]),l=E(new s(512*o,512*a),n+1),c=E(new s(512*(u+1),512*(h+1)),n+1);e=n+1,this._bounds=t.createBounds({nw:l,se:c})}}catch(t){console.log("Mapbox tile optimization failed",t)}const r=yield rt({gl:this._gl,demZoom:e,bounds:this._bounds,terrainSource:this.options.terrainSource,dsmSource:this.options.dsmSource,getFeatures:this.options.getFeatures,buildingRasterizer:this._buildingRasterizer,tileMerger:this._tileMerger,tileLoaded:(t,e)=>this.emit("tileloaded",t,e),forceUpdate:!this._heightMap});this._heightMap=r,r.dirty&&(yield this._draw(r))}return this}))}_draw(t){return r(this,void 0,void 0,(function*(){if(this.options.debug("_draw()"),this._canvas&&this._compiledKernel&&this._map){if(ht({kernel:this._compiledKernel,map:lt(this._map),heightMap:t,color:this._color,opacity:this.options.opacity,now:this.options.date,maxZoom:this.options.terrainSource.maxZoom}),this.options.sunExposure.enabled){const{startDate:t,endDate:e,iterations:r}=this.options.sunExposure;if(!0===(yield at(this._compiledKernel,{startDate:t,endDate:e,iterations:r,emit:this.emit.bind(this)})))return this}this._bounds&&this._repositionCanvas(this._bounds)}return this}))}readPixel(t,e){const r=new Uint8Array(4);return this._gl.readPixels(t,e,1,1,this._gl.RGBA,this._gl.UNSIGNED_BYTE,r),r}toGeoTiff(){const t=(t,e,r,n)=>{const i=new Uint8Array(r*n*4);this._gl.readPixels(t,e,r,n,this._gl.RGBA,this._gl.UNSIGNED_BYTE,i);const o=r*n*1,s=1*r,a=(n-1)*s,u=new Uint8Array(o),h=new Uint8Array(o);let l=0;const{startDate:c,endDate:f}=this.options.sunExposure;this.options.sunExposure.enabled&&c&&f&&(l=f.getTime()-c.getTime());for(let t=0;t<i.length;t+=4){let e;if(this.options.sunExposure.enabled){const r=i.subarray(t,t+3),n=y(r,.5,l)/1e3/60,o=Math.min(Math.floor(n/6),255);e=new Uint8Array([o])}else{e=i[t]+i[t+1]+i[t+2]===0?new Uint8Array([255]):new Uint8Array([0])}u.set(e,t/4*1)}for(let t=0;t<o;t+=s)h.set(u.subarray(t,t+s),a-t);return h};if(this._map){const e=this._canvas.width,r=this._canvas.height,n=t(0,0,e,r),i=lt(this._map),{lat:o,lng:s}=i.getBounds().getNorthWest(),a=i.getBounds().getSouthEast(),u=[0,0,0,s,o,0],h=[(a.lng-s)/e,(o-a.lat)/r,0];return this.options.sunExposure.enabled,{data:n,metadata:{width:e,height:r,ModelTiepoint:u,ModelPixelScale:h,GeographicTypeGeoKey:4326,GeogCitationGeoKey:"WGS 84"}}}return null}_generateShadeProfile(t){if(this._compiledKernel){const e=this._canvas.width,r=this._canvas.height;this._canvas.width=t.locations.length,this._canvas.height=t.dates.length;const n=this._lngLatToTextureCoords(t.locations),i=((t,e)=>{const r=ot({r:e.sunColor[0],g:e.sunColor[1],b:e.sunColor[2]},1),n=ot({r:e.shadeColor[0],g:e.shadeColor[1],b:e.shadeColor[2]},1);return t.generateShadeProfile(Object.assign(Object.assign({},e),{sunColor:r,shadeColor:n}))})(this._compiledKernel,Object.assign(Object.assign({},t),{texCoords:n}));return this._canvas.width=e,this._canvas.height=r,i}return new Uint8Array}_generateLocationShadeProfile(t){if(this._compiledKernel){const e=this._canvas.width,r=this._canvas.height,n=R(t.startDate)-R(t.startDate,t.tzId),i=t.startDate.getTime()-n,o=(t.endDate.getTime()-n-i)/86400/1e3,s=1440;this._canvas.width=o,this._canvas.height=s;const a=[],u=828e5,h=R(new Date(i),t.tzId);for(let e=0;e<o;e++){const r=R(new Date(i+86400*e*1e3+u),t.tzId)-h;a[e]=r}const l=[];for(let t=0;t<s;t++){const e=[];for(let r=0;r<o;r++){const n=i+86400*r*1e3+60*t*1e3;e.push(new Date(n+a[r]))}l.push(e)}const c=this._lngLatToTextureCoords([t.location])[0],f=((t,e)=>{const r=ot({r:e.sunColor[0],g:e.sunColor[1],b:e.sunColor[2]},1),n=ot({r:e.shadeColor[0],g:e.shadeColor[1],b:e.shadeColor[2]},1);return t.generateLocationShadeProfile(Object.assign(Object.assign({},e),{sunColor:r,shadeColor:n}))})(this._compiledKernel,Object.assign(Object.assign({},t),{dates:l,texCoord:c}));return this._canvas.width=e,this._canvas.height=r,f.toArray=function(){const e=new Array;for(let r=0;r<o;r++){const n=[];for(let e=s-1;e>=0;e--){const i=e*o*4+4*r,s=this.slice(i,i+4);n.push(s.join("")===t.sunColor.join("")?1:0)}e.push(n)}return e},{data:f,width:o,height:s}}return{data:new Uint8Array,width:0,height:0}}getHoursOfSun(t,e){if(this.options.sunExposure.enabled){const r=this.readPixel(t,e),{startDate:n,endDate:i}=this.options.sunExposure,o=i.getTime()-n.getTime(),s=y(r,.5,o);return Math.abs(s/1e3/3600)}return 0}_repositionCanvas(t){}_flush(){}flushSync(){this._gl.finish()}_parseColor(t){t=t.replace("#","");const e={r:0,g:0,b:0};return/^([0-9A-F]{3}){1,2}$/i.test(t)&&(3===t.length?(e.r=parseInt(t[0]+t[0],16),e.g=parseInt(t[1]+t[1],16),e.b=parseInt(t[2]+t[2],16)):6===t.length&&(e.r=parseInt(t[0]+t[1],16),e.g=parseInt(t[2]+t[3],16),e.b=parseInt(t[4]+t[5],16))),e}}{constructor(t){super(t)}addTo(t){return this.onAdd(t)}onAdd(t){if(this._map=t,!this._canvasOverlay&&this._canvas){const t=this._map.getBounds();this._canvasOverlay=function(...t){return new e(...t)}(this._canvas,t),this._canvasOverlay.addTo(this._map)}return this._map.on("moveend",this._reset),this._reset(),this}_repositionCanvas(t){this._canvasOverlay&&this._canvasOverlay.setBounds(t),this._flush()}_flush(){this.emit("idle")}}return void 0!==window.L&&(window.L.shadeMap=(...t)=>new ct(...t)),ct}));
